{
 "cells": [
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## MSTICPy and Notebooks in InfoSec\n",
    "---\n",
    "\n",
    "# <a style=\"border: solid; padding:5pt; color:black; background-color:#909090\">Session 3 - Acquiring Data Using MSTICPy</a>\n",
    "\n",
    "---\n",
    "\n",
    "## What this session covers:\n",
    " - Setting up query providers\n",
    " - Connecting to providers\n",
    " - Querying for data\n",
    " - Offline data options\n",
    "\n",
    "## Prerequisites\n",
    "- Python >= 3.8 Environment\n",
    "- Jupyter installed\n",
    "- MSTICPy\n",
    "- The msticpyconfig.yaml file you recently populated\n"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### MSTICPy has a number of supported data providers\n",
    "- Microsoft Sentinel\n",
    "- Microsoft Defender/Defender for Endpoint\n",
    "- Splunk\n",
    "- Sumologic\n",
    "- Microsoft Graph\n",
    "- Local data\n",
    "- Mordor/Security Datasets\n",
    "- Kusto/Azure Data Explorer\n",
    "- Azure Resource Graph\n",
    "\n",
    "These provide way to connect to and query data from these sources in a structured and standardized way.<br>\n",
    "The providers also provide a way to create, store and call templated queries simply and easily.\n",
    "\n",
    "Ref: https://msticpy.readthedocs.io/en/latest/DataAcquisition.html"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "env: MSTICPYCONFIG=./msticpyconfig.yaml\n"
     ]
    }
   ],
   "source": [
    "#Set up MSTICPy\n",
    "%env MSTICPYCONFIG=./msticpyconfig.yaml\n",
    "import msticpy as mp \n",
    "mp.init_notebook()"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The QueryProvider handles this functionality and can be configured to work with the supported data sources.\n",
    "\n",
    "`list_data_environments` shows us the names of the providers available to us."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "['MSSentinel',\n",
       " 'AzureSentinel',\n",
       " 'LogAnalytics',\n",
       " 'Kusto',\n",
       " 'AzureSecurityCenter',\n",
       " 'MSGraph',\n",
       " 'SecurityGraph',\n",
       " 'MDE',\n",
       " 'MDATP',\n",
       " 'LocalData',\n",
       " 'Splunk',\n",
       " 'OTRF',\n",
       " 'Mordor',\n",
       " 'ResourceGraph',\n",
       " 'Sumologic',\n",
       " 'M365D',\n",
       " 'Cybereason',\n",
       " 'Elastic',\n",
       " 'OSQueryLogs',\n",
       " 'MSSentinel_New',\n",
       " 'Kusto_New']"
      ]
     },
     "execution_count": 2,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "mp.QueryProvider.list_data_environments()"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "You can then pass the name of the required provider to `QueryProvider`."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "qry_prov = mp.QueryProvider(\"MSSentinel_New\")"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "# <a style=\"border: solid; padding:5pt; color:black; background-color:#909090\">Authenticating to Providers</a>\n",
    "\n",
    "---\n",
    "\n",
    "Once we have created our QueryProvider for the data source we want the next step is to connect the provider to the source and authenticate. <br>\n",
    "In order to connect we need to tell the provider which instance to connect to, i.e. what workspace, cluster, or database.<br>\n",
    "\n",
    "To do that we need to provide a set of connection parameters or a *connection string*.<br> \n",
    "We can do this **manually** or we can store these details in our `msticpyconfig file` and pull them directly from there.<br>\n",
    "\n",
    "First, we are going to connect using a manually-created connection string, and later using our config file, which is a much more manageable way of handling it.\n",
    "\n",
    "The connection parameters typically require the following information:\n",
    "- An ID of the resource to connect to\n",
    "- An indicator of the credential type you want to use to authenticate\n",
    "- The ID of the authority (AAD) that will authenticate/authorize the connection.\n",
    "- Data source specific parameters (e.g. DefaultDatabase)\n",
    "\n",
    "> Note: Some of these may inherit from your account or other settings\n",
    "\n",
    "The authentication method for the provider will depend on the type of providers, and what is supported.<br>\n",
    "We don't have the breadth to cover all of the options here today but most providers have a authentication method that requires the user to log in each time, either via an interactive login, or device code login.<br>\n",
    "However we can also configure most providers to use tokens already on a host, such as MSI and Azure CLI tokens. This removes the need to authenticate each time.<br>\n",
    "\n",
    "Generally for Microsoft services the following options are supported:\n",
    " - Interactive/Device Code \n",
    " - Azure CLI\n",
    " - MSI\n",
    " - Creds stored as Environment Variables\n",
    " - VSCode or PowerShell Credentials\n",
    "\n",
    "Some other providers (such as Defender) use app level authentication instead. The documentation will detail what authentication options are possible for each provider.\n",
    "\n",
    "### Using an connection string to connect\n",
    "Below we will connect with a specific connection string, and the default auth method for this provider - Device Code.\n",
    "\n",
    "Ref: https://msticpy.readthedocs.io/en/latest/data_acquisition/DataProviders.html"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "la_connection_string = f'loganalytics://code().tenant(\"72f988bf-86f1-41af-91ab-2d7cd011db47\").workspace(\"8ecf8077-cf51-4820-aadd-14040956f35d\")'\n",
    "qry_prov.connect(connection_str=la_connection_string)"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "As we can see the above method is a bit cumbersome for every day use - having a more seamless authentication method, and storing workspace details in config is much smoother.\n",
    "\n",
    "To use the a settings from our config instead of the connection string we can use the<br>\n",
    "`workspace` parameter pull the settings from file and pass them to the connection method.<br>\n",
    "\n",
    "We are also going explicitly request to use Azure CLI credentials using the `auth_methods` parameter.<br>\n",
    "You typically don't need to do this unless you want to override the defaults in `msticpyconfig.yaml`\n",
    "<br>\n",
    "\n",
    "---\n",
    "**Note -**\n",
    "You only need to perform the CLI authentication once per token lifetime rather than every time you connect.<br>\n",
    "If you've done this already today, you probably don't need to do it again."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "!az login"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Now when we connect to our QueryProvider we just need to tell the provider to use CLI authentication. \n",
    "\n",
    "---\n",
    "**Note -**\n",
    "The authentication methods are passed as a list, this is because you can often provide multiple options that it will use in order until it successfully authenticates."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "connected\n"
     ]
    }
   ],
   "source": [
    "qry_prov = mp.QueryProvider(\"MSSentinel_New\")\n",
    "qry_prov.connect(workspace=\"Default\", auth_methods=['cli'])"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Once connected we can start running queries to get data.\n",
    "We can do this with the built in queries or with our own queries.\n",
    "\n",
    "We will start with the built in queries. We can list the available queries with `list_queries`.\n",
    "\n",
    "Ref: https://msticpy.readthedocs.io/en/latest/DataAcquisition.html#built-in-data-queries"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "['Azure.get_vmcomputer_for_host',\n",
       " 'Azure.get_vmcomputer_for_ip',\n",
       " 'Azure.list_aad_signins_for_account',\n",
       " 'Azure.list_aad_signins_for_ip',\n",
       " 'Azure.list_all_signins_geo',\n",
       " 'Azure.list_azure_activity_for_account',\n",
       " 'Azure.list_azure_activity_for_ip',\n",
       " 'Azure.list_azure_activity_for_resource',\n",
       " 'Azure.list_storage_ops_for_hash',\n",
       " 'Azure.list_storage_ops_for_ip',\n",
       " 'AzureNetwork.all_network_connections_csl',\n",
       " 'AzureNetwork.az_net_analytics',\n",
       " 'AzureNetwork.dns_lookups_for_domain',\n",
       " 'AzureNetwork.dns_lookups_for_ip',\n",
       " 'AzureNetwork.dns_lookups_from_ip',\n",
       " 'AzureNetwork.get_heartbeat_for_host',\n",
       " 'AzureNetwork.get_heartbeat_for_ip',\n",
       " 'AzureNetwork.get_host_for_ip',\n",
       " 'AzureNetwork.get_ips_for_host',\n",
       " 'AzureNetwork.host_network_connections_csl',\n",
       " 'AzureNetwork.hosts_by_ip_csl',\n",
       " 'AzureNetwork.ip_network_connections_csl',\n",
       " 'AzureNetwork.ips_by_host_csl',\n",
       " 'AzureNetwork.list_azure_network_flows_by_host',\n",
       " 'AzureNetwork.list_azure_network_flows_by_ip',\n",
       " 'AzureNetwork.network_connections_to_url',\n",
       " 'AzureSentinel.get_bookmark_by_id',\n",
       " 'AzureSentinel.get_bookmark_by_name',\n",
       " 'AzureSentinel.get_dynamic_summary_by_id',\n",
       " 'AzureSentinel.get_dynamic_summary_by_name',\n",
       " 'AzureSentinel.list_bookmarks',\n",
       " 'AzureSentinel.list_bookmarks_for_entity',\n",
       " 'AzureSentinel.list_bookmarks_for_tags',\n",
       " 'AzureSentinel.list_dynamic_summaries',\n",
       " 'Heartbeat.get_heartbeat_for_host',\n",
       " 'Heartbeat.get_heartbeat_for_ip',\n",
       " 'Heartbeat.get_info_by_hostname',\n",
       " 'Heartbeat.get_info_by_ipaddress',\n",
       " 'LinuxAudit.auditd_all',\n",
       " 'LinuxSyslog.all_syslog',\n",
       " 'LinuxSyslog.cron_activity',\n",
       " 'LinuxSyslog.list_account_logon_failures',\n",
       " 'LinuxSyslog.list_host_logon_failures',\n",
       " 'LinuxSyslog.list_ip_logon_failures',\n",
       " 'LinuxSyslog.list_logon_failures',\n",
       " 'LinuxSyslog.list_logons_for_account',\n",
       " 'LinuxSyslog.list_logons_for_host',\n",
       " 'LinuxSyslog.list_logons_for_source_ip',\n",
       " 'LinuxSyslog.notable_events',\n",
       " 'LinuxSyslog.squid_activity',\n",
       " 'LinuxSyslog.sudo_activity',\n",
       " 'LinuxSyslog.summarize_events',\n",
       " 'LinuxSyslog.sysmon_process_events',\n",
       " 'LinuxSyslog.user_group_activity',\n",
       " 'LinuxSyslog.user_logon',\n",
       " 'MDATP.file_path',\n",
       " 'MDATP.host_connections',\n",
       " 'MDATP.ip_connections',\n",
       " 'MDATP.list_connections',\n",
       " 'MDATP.list_filehash',\n",
       " 'MDATP.list_files',\n",
       " 'MDATP.list_host_processes',\n",
       " 'MDATP.process_cmd_line',\n",
       " 'MDATP.process_creations',\n",
       " 'MDATP.process_paths',\n",
       " 'MDATP.protocol_connections',\n",
       " 'MDATP.url_connections',\n",
       " 'MDATP.user_files',\n",
       " 'MDATP.user_logons',\n",
       " 'MDATP.user_network',\n",
       " 'MDATP.user_processes',\n",
       " 'MDATPHunting.accessibility_persistence',\n",
       " 'MDATPHunting.av_sites',\n",
       " 'MDATPHunting.b64_pe',\n",
       " 'MDATPHunting.brute_force',\n",
       " 'MDATPHunting.cve_2018_1000006l',\n",
       " 'MDATPHunting.cve_2018_1111',\n",
       " 'MDATPHunting.cve_2018_4878',\n",
       " 'MDATPHunting.doc_with_link',\n",
       " 'MDATPHunting.dropbox_link',\n",
       " 'MDATPHunting.email_link',\n",
       " 'MDATPHunting.email_smartscreen',\n",
       " 'MDATPHunting.malware_recycle',\n",
       " 'MDATPHunting.network_scans',\n",
       " 'MDATPHunting.powershell_downloads',\n",
       " 'MDATPHunting.service_account_powershell',\n",
       " 'MDATPHunting.smartscreen_ignored',\n",
       " 'MDATPHunting.smb_discovery',\n",
       " 'MDATPHunting.tor',\n",
       " 'MDATPHunting.uncommon_powershell',\n",
       " 'MDATPHunting.user_enumeration',\n",
       " 'MDE.accessibility_persistence',\n",
       " 'MDE.av_sites',\n",
       " 'MDE.b64_pe',\n",
       " 'MDE.brute_force',\n",
       " 'MDE.cve_2018_1000006l',\n",
       " 'MDE.cve_2018_1111',\n",
       " 'MDE.cve_2018_4878',\n",
       " 'MDE.doc_with_link',\n",
       " 'MDE.dropbox_link',\n",
       " 'MDE.email_link',\n",
       " 'MDE.email_smartscreen',\n",
       " 'MDE.file_path',\n",
       " 'MDE.host_connections',\n",
       " 'MDE.ip_connections',\n",
       " 'MDE.list_connections',\n",
       " 'MDE.list_filehash',\n",
       " 'MDE.list_files',\n",
       " 'MDE.list_host_processes',\n",
       " 'MDE.malware_recycle',\n",
       " 'MDE.network_scans',\n",
       " 'MDE.powershell_downloads',\n",
       " 'MDE.process_cmd_line',\n",
       " 'MDE.process_creations',\n",
       " 'MDE.process_paths',\n",
       " 'MDE.protocol_connections',\n",
       " 'MDE.service_account_powershell',\n",
       " 'MDE.smartscreen_ignored',\n",
       " 'MDE.smb_discovery',\n",
       " 'MDE.tor',\n",
       " 'MDE.uncommon_powershell',\n",
       " 'MDE.url_connections',\n",
       " 'MDE.user_enumeration',\n",
       " 'MDE.user_files',\n",
       " 'MDE.user_logons',\n",
       " 'MDE.user_network',\n",
       " 'MDE.user_processes',\n",
       " 'MSSentinel.get_bookmark_by_id',\n",
       " 'MSSentinel.get_bookmark_by_name',\n",
       " 'MSSentinel.get_dynamic_summary_by_id',\n",
       " 'MSSentinel.get_dynamic_summary_by_name',\n",
       " 'MSSentinel.list_bookmarks',\n",
       " 'MSSentinel.list_bookmarks_for_entity',\n",
       " 'MSSentinel.list_bookmarks_for_tags',\n",
       " 'MSSentinel.list_dynamic_summaries',\n",
       " 'MultiDataSource.get_timeseries_anomalies',\n",
       " 'MultiDataSource.get_timeseries_data',\n",
       " 'MultiDataSource.get_timeseries_decompose',\n",
       " 'MultiDataSource.plot_timeseries_datawithbaseline',\n",
       " 'MultiDataSource.plot_timeseries_scoreanomolies',\n",
       " 'Network.all_network_connections_csl',\n",
       " 'Network.get_heartbeat_for_host',\n",
       " 'Network.get_heartbeat_for_ip',\n",
       " 'Network.get_host_for_ip',\n",
       " 'Network.get_ips_for_host',\n",
       " 'Network.host_network_connections_csl',\n",
       " 'Network.hosts_by_ip_csl',\n",
       " 'Network.ip_network_connections_csl',\n",
       " 'Network.ips_by_host_csl',\n",
       " 'Network.list_azure_network_flows_by_host',\n",
       " 'Network.list_azure_network_flows_by_ip',\n",
       " 'Network.network_connections_to_url',\n",
       " 'Office365.list_activity_for_account',\n",
       " 'Office365.list_activity_for_ip',\n",
       " 'Office365.list_activity_for_resource',\n",
       " 'SecurityAlert.get_alert',\n",
       " 'SecurityAlert.list_alerts',\n",
       " 'SecurityAlert.list_alerts_counts',\n",
       " 'SecurityAlert.list_alerts_for_ip',\n",
       " 'SecurityAlert.list_related_alerts',\n",
       " 'ThreatIntelligence.list_indicators',\n",
       " 'ThreatIntelligence.list_indicators_by_domain',\n",
       " 'ThreatIntelligence.list_indicators_by_email',\n",
       " 'ThreatIntelligence.list_indicators_by_filepath',\n",
       " 'ThreatIntelligence.list_indicators_by_hash',\n",
       " 'ThreatIntelligence.list_indicators_by_ip',\n",
       " 'ThreatIntelligence.list_indicators_by_url',\n",
       " 'WindowsSecurity.account_change_events',\n",
       " 'WindowsSecurity.get_host_logon',\n",
       " 'WindowsSecurity.get_parent_process',\n",
       " 'WindowsSecurity.get_process_tree',\n",
       " 'WindowsSecurity.list_all_logons_by_host',\n",
       " 'WindowsSecurity.list_events',\n",
       " 'WindowsSecurity.list_events_by_id',\n",
       " 'WindowsSecurity.list_host_events',\n",
       " 'WindowsSecurity.list_host_events_by_id',\n",
       " 'WindowsSecurity.list_host_logon_failures',\n",
       " 'WindowsSecurity.list_host_logons',\n",
       " 'WindowsSecurity.list_host_processes',\n",
       " 'WindowsSecurity.list_hosts_matching_commandline',\n",
       " 'WindowsSecurity.list_logon_attempts_by_account',\n",
       " 'WindowsSecurity.list_logon_attempts_by_ip',\n",
       " 'WindowsSecurity.list_logon_failures_by_account',\n",
       " 'WindowsSecurity.list_logons_by_account',\n",
       " 'WindowsSecurity.list_matching_processes',\n",
       " 'WindowsSecurity.list_other_events',\n",
       " 'WindowsSecurity.list_processes_in_session',\n",
       " 'WindowsSecurity.notable_events',\n",
       " 'WindowsSecurity.schdld_tasks_and_services',\n",
       " 'WindowsSecurity.summarize_events']"
      ]
     },
     "execution_count": 6,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "qry_prov.list_queries()"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "We can also use `browse` to get a clearer view of whats available"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "bfaf047961694ac98f5c9ca7838abe00",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "VBox(children=(Text(value='Azure.get_vmcomputer_for_host', description='Filter:', style=DescriptionStyle(descr…"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<hr>"
      ],
      "text/plain": [
       "<IPython.core.display.HTML object>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<h3>Gets latest VMComputer record for Host</h3><div></div><p><b>Parameters</b></p><div>add_query_items: str (optional)</div><div style='margin-left: 40px'>    Additional query clauses</div><div>end: datetime</div><div style='margin-left: 40px'>    Query end time</div><div>host_name: str</div><div style='margin-left: 40px'>    The Computer name of the VM</div><div>start: datetime</div><div style='margin-left: 40px'>    Query start time</div><div>table: str (optional)</div><div style='margin-left: 40px'>    Table name</div><div style='margin-left: 40px'>    (default value is: VMComputer)</div><br><p><b>Query</b></p><pre>{table} \n",
       "| where TimeGenerated >= datetime({start}) \n",
       "| where TimeGenerated <= datetime({end}) \n",
       "| where Computer has \"{host_name}\" \n",
       "| take 1</pre><br>\n",
       "        <p><b>Example</b></p>\n",
       "        <p>{QueryProvider}[.QueryPath].QueryName(params...)</p>\n",
       "        <pre>qry_prov.Azure.get_vmcomputer_for_host(start=start, end=end, hostname=host)</pre>\n",
       "    "
      ],
      "text/plain": [
       "<IPython.core.display.HTML object>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "qry_prov.browse()"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "You can also search for a query:\n",
    "- just supply a string or regex (or a list of search terms) to search over all query metadata\n",
    "- search for queries using a specific table name (`table=\"DeviceProcessEvents\")\n",
    "- search for queries using a specific parameter name\n",
    "\n",
    "Examples:\n",
    "```python\n",
    "qry_prov.search(\"ip_address\")\n",
    "qry_prov.search(\"ip_address\", table=\"Office\")\n",
    "qry_prov.search(param=\"URL\")\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "['Azure.get_vmcomputer_for_ip',\n",
       " 'Azure.list_aad_signins_for_ip',\n",
       " 'Azure.list_azure_activity_for_ip',\n",
       " 'Azure.list_storage_ops_for_ip',\n",
       " 'AzureNetwork.dns_lookups_for_ip',\n",
       " 'AzureNetwork.dns_lookups_from_ip',\n",
       " 'AzureNetwork.get_heartbeat_for_ip',\n",
       " 'AzureNetwork.get_host_for_ip',\n",
       " 'AzureNetwork.hosts_by_ip_csl',\n",
       " 'AzureNetwork.ip_network_connections_csl',\n",
       " 'AzureNetwork.list_azure_network_flows_by_ip',\n",
       " 'AzureSentinel.list_bookmarks_for_entity',\n",
       " 'Heartbeat.get_heartbeat_for_ip',\n",
       " 'Heartbeat.get_info_by_ipaddress',\n",
       " 'LinuxSyslog.list_ip_logon_failures',\n",
       " 'LinuxSyslog.list_logons_for_source_ip',\n",
       " 'MDATP.ip_connections',\n",
       " 'MDE.ip_connections',\n",
       " 'MSSentinel.list_bookmarks_for_entity',\n",
       " 'Network.get_heartbeat_for_ip',\n",
       " 'Network.get_host_for_ip',\n",
       " 'Network.hosts_by_ip_csl',\n",
       " 'Network.ip_network_connections_csl',\n",
       " 'Network.list_azure_network_flows_by_ip',\n",
       " 'Office365.list_activity_for_ip',\n",
       " 'ThreatIntelligence.list_indicators_by_ip',\n",
       " 'WindowsSecurity.list_logon_attempts_by_ip']"
      ]
     },
     "execution_count": 16,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "qry_prov.search(\"ip_address\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "['AzureNetwork.network_connections_to_url',\n",
       " 'AzureSentinel.list_bookmarks_for_entity',\n",
       " 'MDATP.url_connections',\n",
       " 'MDE.url_connections',\n",
       " 'MSSentinel.list_bookmarks_for_entity',\n",
       " 'Network.network_connections_to_url',\n",
       " 'ThreatIntelligence.list_indicators_by_url']"
      ]
     },
     "execution_count": 17,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "qry_prov.search(param=\"url\")"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Running a query is a function call"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>TenantId</th>\n",
       "      <th>SourceSystem</th>\n",
       "      <th>TimeGenerated</th>\n",
       "      <th>ResourceId</th>\n",
       "      <th>OperationName</th>\n",
       "      <th>OperationVersion</th>\n",
       "      <th>Category</th>\n",
       "      <th>ResultType</th>\n",
       "      <th>ResultSignature</th>\n",
       "      <th>ResultDescription</th>\n",
       "      <th>DurationMs</th>\n",
       "      <th>CorrelationId</th>\n",
       "      <th>Resource</th>\n",
       "      <th>ResourceGroup</th>\n",
       "      <th>ResourceProvider</th>\n",
       "      <th>Identity</th>\n",
       "      <th>Level</th>\n",
       "      <th>Location</th>\n",
       "      <th>AlternateSignInName</th>\n",
       "      <th>AppDisplayName</th>\n",
       "      <th>AppId</th>\n",
       "      <th>AuthenticationContextClassReferences</th>\n",
       "      <th>AuthenticationDetails</th>\n",
       "      <th>AppliedEventListeners</th>\n",
       "      <th>AuthenticationMethodsUsed</th>\n",
       "      <th>...</th>\n",
       "      <th>TokenIssuerName</th>\n",
       "      <th>TokenIssuerType</th>\n",
       "      <th>UserAgent</th>\n",
       "      <th>UserDisplayName</th>\n",
       "      <th>UserId</th>\n",
       "      <th>UserPrincipalName</th>\n",
       "      <th>AADTenantId</th>\n",
       "      <th>UserType</th>\n",
       "      <th>FlaggedForReview</th>\n",
       "      <th>IPAddressFromResourceProvider</th>\n",
       "      <th>SignInIdentifier</th>\n",
       "      <th>SignInIdentifierType</th>\n",
       "      <th>ResourceTenantId</th>\n",
       "      <th>HomeTenantId</th>\n",
       "      <th>UniqueTokenIdentifier</th>\n",
       "      <th>SessionLifetimePolicies</th>\n",
       "      <th>AutonomousSystemNumber</th>\n",
       "      <th>AuthenticationProtocol</th>\n",
       "      <th>CrossTenantAccessType</th>\n",
       "      <th>AppliedConditionalAccessPolicies</th>\n",
       "      <th>RiskLevel</th>\n",
       "      <th>Type</th>\n",
       "      <th>Result</th>\n",
       "      <th>Latitude</th>\n",
       "      <th>Longitude</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>8ecf8077-cf51-4820-aadd-14040956f35d</td>\n",
       "      <td>Azure AD</td>\n",
       "      <td>2023-06-15 15:58:40.834513+00:00</td>\n",
       "      <td>/tenants/4b2462a4-bbee-495a-a0e1-f23ae524cc9c/providers/Microsoft.aadiam</td>\n",
       "      <td>Sign-in activity</td>\n",
       "      <td>1.0</td>\n",
       "      <td>SignInLogs</td>\n",
       "      <td>0</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td>0</td>\n",
       "      <td>ac8c1a8e-f199-4192-8cd7-c38343d8bad0</td>\n",
       "      <td>Microsoft.aadiam</td>\n",
       "      <td>Microsoft.aadiam</td>\n",
       "      <td></td>\n",
       "      <td>Pamela Hatfield</td>\n",
       "      <td>4</td>\n",
       "      <td>US</td>\n",
       "      <td></td>\n",
       "      <td>WindowsDefenderATP</td>\n",
       "      <td>fc780465-2017-40d4-a0c5-307022471b92</td>\n",
       "      <td>[{\"id\":\"urn:microsoft:req1\",\"detail\":\"previouslySatisfied\"}]</td>\n",
       "      <td>[]</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td>...</td>\n",
       "      <td></td>\n",
       "      <td>AzureAD</td>\n",
       "      <td></td>\n",
       "      <td>Pamela Hatfield</td>\n",
       "      <td>0aecd75b-4a61-475d-8a81-a85e413759c5</td>\n",
       "      <td>phatfield@microsoft.com</td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>Guest</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>72f988bf-86f1-41af-91ab-2d7cd011db47</td>\n",
       "      <td>svLzCuitbUW3Hsl_U2EuAA</td>\n",
       "      <td>[]</td>\n",
       "      <td>7018</td>\n",
       "      <td>none</td>\n",
       "      <td>b2bCollaboration</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>SigninLogs</td>\n",
       "      <td>Sucess</td>\n",
       "      <td>32.37963104248047</td>\n",
       "      <td>-86.29824829101563</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>8ecf8077-cf51-4820-aadd-14040956f35d</td>\n",
       "      <td>Azure AD</td>\n",
       "      <td>2023-06-15 15:59:48.500535+00:00</td>\n",
       "      <td>/tenants/4b2462a4-bbee-495a-a0e1-f23ae524cc9c/providers/Microsoft.aadiam</td>\n",
       "      <td>Sign-in activity</td>\n",
       "      <td>1.0</td>\n",
       "      <td>SignInLogs</td>\n",
       "      <td>0</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td>0</td>\n",
       "      <td>c0d39227-01fd-4ea5-97c8-948f2cc8653e</td>\n",
       "      <td>Microsoft.aadiam</td>\n",
       "      <td>Microsoft.aadiam</td>\n",
       "      <td></td>\n",
       "      <td>Pamela Hatfield</td>\n",
       "      <td>4</td>\n",
       "      <td>US</td>\n",
       "      <td></td>\n",
       "      <td>Office 365 Information Protection</td>\n",
       "      <td>2f3f02c9-5679-4a5c-a605-0de55b07d135</td>\n",
       "      <td>[{\"id\":\"urn:microsoft:req1\",\"detail\":\"previouslySatisfied\"}]</td>\n",
       "      <td>[]</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td>...</td>\n",
       "      <td></td>\n",
       "      <td>AzureAD</td>\n",
       "      <td></td>\n",
       "      <td>Pamela Hatfield</td>\n",
       "      <td>0aecd75b-4a61-475d-8a81-a85e413759c5</td>\n",
       "      <td>phatfield@microsoft.com</td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>Guest</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>72f988bf-86f1-41af-91ab-2d7cd011db47</td>\n",
       "      <td>I6OaFKdKCkqez3Pg9IMQAA</td>\n",
       "      <td>[]</td>\n",
       "      <td>7018</td>\n",
       "      <td>none</td>\n",
       "      <td>b2bCollaboration</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>SigninLogs</td>\n",
       "      <td>Sucess</td>\n",
       "      <td>32.37963104248047</td>\n",
       "      <td>-86.29824829101563</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>8ecf8077-cf51-4820-aadd-14040956f35d</td>\n",
       "      <td>Azure AD</td>\n",
       "      <td>2023-06-15 16:02:34.975442+00:00</td>\n",
       "      <td>/tenants/4b2462a4-bbee-495a-a0e1-f23ae524cc9c/providers/Microsoft.aadiam</td>\n",
       "      <td>Sign-in activity</td>\n",
       "      <td>1.0</td>\n",
       "      <td>SignInLogs</td>\n",
       "      <td>0</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td>0</td>\n",
       "      <td>42f91de8-4372-487e-a72c-627f1dd0f984</td>\n",
       "      <td>Microsoft.aadiam</td>\n",
       "      <td>Microsoft.aadiam</td>\n",
       "      <td></td>\n",
       "      <td>Partner Demo</td>\n",
       "      <td>4</td>\n",
       "      <td>GB</td>\n",
       "      <td></td>\n",
       "      <td>Microsoft App Access Panel</td>\n",
       "      <td>0000000c-0000-0000-c000-000000000000</td>\n",
       "      <td>[{\"id\":\"urn:microsoft:req1\",\"detail\":\"previouslySatisfied\"}]</td>\n",
       "      <td>[{\"authenticationStepDateTime\":\"2023-06-15T16:00:45.9299713+00:00\",\"authenticationMethod\":\"Previ...</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td>...</td>\n",
       "      <td></td>\n",
       "      <td>AzureAD</td>\n",
       "      <td>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0....</td>\n",
       "      <td>Partner Demo</td>\n",
       "      <td>dfc3c1b8-483a-40ca-8412-d8420cc9d79f</td>\n",
       "      <td>pdemo@seccxpninja.onmicrosoft.com</td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>Member</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>R78ziJWG6EiPMvrx2EYWAA</td>\n",
       "      <td>[{\"expirationRequirement\":\"rememberMultifactorAuthenticationOnTrustedDevices\",\"detail\":\"Remember...</td>\n",
       "      <td>5089</td>\n",
       "      <td>none</td>\n",
       "      <td>none</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>SigninLogs</td>\n",
       "      <td>Sucess</td>\n",
       "      <td>51.445831298828128</td>\n",
       "      <td>-0.9697200059890748</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>8ecf8077-cf51-4820-aadd-14040956f35d</td>\n",
       "      <td>Azure AD</td>\n",
       "      <td>2023-06-15 16:03:49.941578+00:00</td>\n",
       "      <td>/tenants/4b2462a4-bbee-495a-a0e1-f23ae524cc9c/providers/Microsoft.aadiam</td>\n",
       "      <td>Sign-in activity</td>\n",
       "      <td>1.0</td>\n",
       "      <td>SignInLogs</td>\n",
       "      <td>0</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td>0</td>\n",
       "      <td>4206165e-a3a8-480e-adf0-edb26c46d194</td>\n",
       "      <td>Microsoft.aadiam</td>\n",
       "      <td>Microsoft.aadiam</td>\n",
       "      <td></td>\n",
       "      <td>Eric Adams</td>\n",
       "      <td>4</td>\n",
       "      <td>US</td>\n",
       "      <td></td>\n",
       "      <td>Azure Portal</td>\n",
       "      <td>c44b4083-3bb0-49c1-b47d-974e53cbdf3c</td>\n",
       "      <td>[{\"id\":\"urn:microsoft:req1\",\"detail\":\"previouslySatisfied\"}]</td>\n",
       "      <td>[{\"authenticationStepDateTime\":\"2023-06-15T16:01:44.1182827+00:00\",\"authenticationMethod\":\"Previ...</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td>...</td>\n",
       "      <td></td>\n",
       "      <td>AzureAD</td>\n",
       "      <td>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0....</td>\n",
       "      <td>Eric Adams</td>\n",
       "      <td>e0a2757f-fe93-4923-b5b5-409d1f3778b8</td>\n",
       "      <td>erica@microsoft.com</td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>Guest</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>72f988bf-86f1-41af-91ab-2d7cd011db47</td>\n",
       "      <td>ML0PSazmiEab3TVHLitQAA</td>\n",
       "      <td>[{\"expirationRequirement\":\"rememberMultifactorAuthenticationOnTrustedDevices\",\"detail\":\"Remember...</td>\n",
       "      <td>5650</td>\n",
       "      <td>none</td>\n",
       "      <td>b2bCollaboration</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>SigninLogs</td>\n",
       "      <td>Sucess</td>\n",
       "      <td>33.01533889770508</td>\n",
       "      <td>-97.06397247314452</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>8ecf8077-cf51-4820-aadd-14040956f35d</td>\n",
       "      <td>Azure AD</td>\n",
       "      <td>2023-06-15 16:04:39.345446+00:00</td>\n",
       "      <td>/tenants/4b2462a4-bbee-495a-a0e1-f23ae524cc9c/providers/Microsoft.aadiam</td>\n",
       "      <td>Sign-in activity</td>\n",
       "      <td>1.0</td>\n",
       "      <td>SignInLogs</td>\n",
       "      <td>0</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td>0</td>\n",
       "      <td>8636b28c-8ab1-4fe3-841d-ad1cf33323e6</td>\n",
       "      <td>Microsoft.aadiam</td>\n",
       "      <td>Microsoft.aadiam</td>\n",
       "      <td></td>\n",
       "      <td>Pamela Hatfield</td>\n",
       "      <td>4</td>\n",
       "      <td>US</td>\n",
       "      <td></td>\n",
       "      <td>Microsoft 365 Security and Compliance Center</td>\n",
       "      <td>80ccca67-54bd-44ab-8625-4b79c4dc7775</td>\n",
       "      <td>[{\"id\":\"urn:microsoft:req1\",\"detail\":\"previouslySatisfied\"}]</td>\n",
       "      <td>[]</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td>...</td>\n",
       "      <td></td>\n",
       "      <td>AzureAD</td>\n",
       "      <td></td>\n",
       "      <td>Pamela Hatfield</td>\n",
       "      <td>0aecd75b-4a61-475d-8a81-a85e413759c5</td>\n",
       "      <td>phatfield@microsoft.com</td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>Guest</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>72f988bf-86f1-41af-91ab-2d7cd011db47</td>\n",
       "      <td>xkDoKmnaVEu77gIOiCw1AA</td>\n",
       "      <td>[]</td>\n",
       "      <td>7018</td>\n",
       "      <td>none</td>\n",
       "      <td>b2bCollaboration</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>SigninLogs</td>\n",
       "      <td>Sucess</td>\n",
       "      <td>32.37963104248047</td>\n",
       "      <td>-86.29824829101563</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>5 rows × 79 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "                               TenantId SourceSystem  \\\n",
       "0  8ecf8077-cf51-4820-aadd-14040956f35d     Azure AD   \n",
       "1  8ecf8077-cf51-4820-aadd-14040956f35d     Azure AD   \n",
       "2  8ecf8077-cf51-4820-aadd-14040956f35d     Azure AD   \n",
       "3  8ecf8077-cf51-4820-aadd-14040956f35d     Azure AD   \n",
       "4  8ecf8077-cf51-4820-aadd-14040956f35d     Azure AD   \n",
       "\n",
       "                     TimeGenerated  \\\n",
       "0 2023-06-15 15:58:40.834513+00:00   \n",
       "1 2023-06-15 15:59:48.500535+00:00   \n",
       "2 2023-06-15 16:02:34.975442+00:00   \n",
       "3 2023-06-15 16:03:49.941578+00:00   \n",
       "4 2023-06-15 16:04:39.345446+00:00   \n",
       "\n",
       "                                                                 ResourceId  \\\n",
       "0  /tenants/4b2462a4-bbee-495a-a0e1-f23ae524cc9c/providers/Microsoft.aadiam   \n",
       "1  /tenants/4b2462a4-bbee-495a-a0e1-f23ae524cc9c/providers/Microsoft.aadiam   \n",
       "2  /tenants/4b2462a4-bbee-495a-a0e1-f23ae524cc9c/providers/Microsoft.aadiam   \n",
       "3  /tenants/4b2462a4-bbee-495a-a0e1-f23ae524cc9c/providers/Microsoft.aadiam   \n",
       "4  /tenants/4b2462a4-bbee-495a-a0e1-f23ae524cc9c/providers/Microsoft.aadiam   \n",
       "\n",
       "      OperationName OperationVersion    Category ResultType ResultSignature  \\\n",
       "0  Sign-in activity              1.0  SignInLogs          0            None   \n",
       "1  Sign-in activity              1.0  SignInLogs          0            None   \n",
       "2  Sign-in activity              1.0  SignInLogs          0            None   \n",
       "3  Sign-in activity              1.0  SignInLogs          0            None   \n",
       "4  Sign-in activity              1.0  SignInLogs          0            None   \n",
       "\n",
       "  ResultDescription  DurationMs                         CorrelationId  \\\n",
       "0                             0  ac8c1a8e-f199-4192-8cd7-c38343d8bad0   \n",
       "1                             0  c0d39227-01fd-4ea5-97c8-948f2cc8653e   \n",
       "2                             0  42f91de8-4372-487e-a72c-627f1dd0f984   \n",
       "3                             0  4206165e-a3a8-480e-adf0-edb26c46d194   \n",
       "4                             0  8636b28c-8ab1-4fe3-841d-ad1cf33323e6   \n",
       "\n",
       "           Resource     ResourceGroup ResourceProvider         Identity Level  \\\n",
       "0  Microsoft.aadiam  Microsoft.aadiam                   Pamela Hatfield     4   \n",
       "1  Microsoft.aadiam  Microsoft.aadiam                   Pamela Hatfield     4   \n",
       "2  Microsoft.aadiam  Microsoft.aadiam                      Partner Demo     4   \n",
       "3  Microsoft.aadiam  Microsoft.aadiam                        Eric Adams     4   \n",
       "4  Microsoft.aadiam  Microsoft.aadiam                   Pamela Hatfield     4   \n",
       "\n",
       "  Location AlternateSignInName                                AppDisplayName  \\\n",
       "0       US                                                WindowsDefenderATP   \n",
       "1       US                                 Office 365 Information Protection   \n",
       "2       GB                                        Microsoft App Access Panel   \n",
       "3       US                                                      Azure Portal   \n",
       "4       US                      Microsoft 365 Security and Compliance Center   \n",
       "\n",
       "                                  AppId  \\\n",
       "0  fc780465-2017-40d4-a0c5-307022471b92   \n",
       "1  2f3f02c9-5679-4a5c-a605-0de55b07d135   \n",
       "2  0000000c-0000-0000-c000-000000000000   \n",
       "3  c44b4083-3bb0-49c1-b47d-974e53cbdf3c   \n",
       "4  80ccca67-54bd-44ab-8625-4b79c4dc7775   \n",
       "\n",
       "                           AuthenticationContextClassReferences  \\\n",
       "0  [{\"id\":\"urn:microsoft:req1\",\"detail\":\"previouslySatisfied\"}]   \n",
       "1  [{\"id\":\"urn:microsoft:req1\",\"detail\":\"previouslySatisfied\"}]   \n",
       "2  [{\"id\":\"urn:microsoft:req1\",\"detail\":\"previouslySatisfied\"}]   \n",
       "3  [{\"id\":\"urn:microsoft:req1\",\"detail\":\"previouslySatisfied\"}]   \n",
       "4  [{\"id\":\"urn:microsoft:req1\",\"detail\":\"previouslySatisfied\"}]   \n",
       "\n",
       "                                                                                 AuthenticationDetails  \\\n",
       "0                                                                                                   []   \n",
       "1                                                                                                   []   \n",
       "2  [{\"authenticationStepDateTime\":\"2023-06-15T16:00:45.9299713+00:00\",\"authenticationMethod\":\"Previ...   \n",
       "3  [{\"authenticationStepDateTime\":\"2023-06-15T16:01:44.1182827+00:00\",\"authenticationMethod\":\"Previ...   \n",
       "4                                                                                                   []   \n",
       "\n",
       "  AppliedEventListeners AuthenticationMethodsUsed  ... TokenIssuerName  \\\n",
       "0                  None                            ...                   \n",
       "1                  None                            ...                   \n",
       "2                  None                            ...                   \n",
       "3                  None                            ...                   \n",
       "4                  None                            ...                   \n",
       "\n",
       "  TokenIssuerType  \\\n",
       "0         AzureAD   \n",
       "1         AzureAD   \n",
       "2         AzureAD   \n",
       "3         AzureAD   \n",
       "4         AzureAD   \n",
       "\n",
       "                                                                                             UserAgent  \\\n",
       "0                                                                                                        \n",
       "1                                                                                                        \n",
       "2  Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0....   \n",
       "3  Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0....   \n",
       "4                                                                                                        \n",
       "\n",
       "   UserDisplayName                                UserId  \\\n",
       "0  Pamela Hatfield  0aecd75b-4a61-475d-8a81-a85e413759c5   \n",
       "1  Pamela Hatfield  0aecd75b-4a61-475d-8a81-a85e413759c5   \n",
       "2     Partner Demo  dfc3c1b8-483a-40ca-8412-d8420cc9d79f   \n",
       "3       Eric Adams  e0a2757f-fe93-4923-b5b5-409d1f3778b8   \n",
       "4  Pamela Hatfield  0aecd75b-4a61-475d-8a81-a85e413759c5   \n",
       "\n",
       "                   UserPrincipalName                           AADTenantId  \\\n",
       "0            phatfield@microsoft.com  4b2462a4-bbee-495a-a0e1-f23ae524cc9c   \n",
       "1            phatfield@microsoft.com  4b2462a4-bbee-495a-a0e1-f23ae524cc9c   \n",
       "2  pdemo@seccxpninja.onmicrosoft.com  4b2462a4-bbee-495a-a0e1-f23ae524cc9c   \n",
       "3                erica@microsoft.com  4b2462a4-bbee-495a-a0e1-f23ae524cc9c   \n",
       "4            phatfield@microsoft.com  4b2462a4-bbee-495a-a0e1-f23ae524cc9c   \n",
       "\n",
       "  UserType  FlaggedForReview IPAddressFromResourceProvider SignInIdentifier  \\\n",
       "0    Guest              None                                                  \n",
       "1    Guest              None                                                  \n",
       "2   Member              None                                                  \n",
       "3    Guest              None                                                  \n",
       "4    Guest              None                                                  \n",
       "\n",
       "  SignInIdentifierType                      ResourceTenantId  \\\n",
       "0                       4b2462a4-bbee-495a-a0e1-f23ae524cc9c   \n",
       "1                       4b2462a4-bbee-495a-a0e1-f23ae524cc9c   \n",
       "2                       4b2462a4-bbee-495a-a0e1-f23ae524cc9c   \n",
       "3                       4b2462a4-bbee-495a-a0e1-f23ae524cc9c   \n",
       "4                       4b2462a4-bbee-495a-a0e1-f23ae524cc9c   \n",
       "\n",
       "                           HomeTenantId   UniqueTokenIdentifier  \\\n",
       "0  72f988bf-86f1-41af-91ab-2d7cd011db47  svLzCuitbUW3Hsl_U2EuAA   \n",
       "1  72f988bf-86f1-41af-91ab-2d7cd011db47  I6OaFKdKCkqez3Pg9IMQAA   \n",
       "2  4b2462a4-bbee-495a-a0e1-f23ae524cc9c  R78ziJWG6EiPMvrx2EYWAA   \n",
       "3  72f988bf-86f1-41af-91ab-2d7cd011db47  ML0PSazmiEab3TVHLitQAA   \n",
       "4  72f988bf-86f1-41af-91ab-2d7cd011db47  xkDoKmnaVEu77gIOiCw1AA   \n",
       "\n",
       "                                                                               SessionLifetimePolicies  \\\n",
       "0                                                                                                   []   \n",
       "1                                                                                                   []   \n",
       "2  [{\"expirationRequirement\":\"rememberMultifactorAuthenticationOnTrustedDevices\",\"detail\":\"Remember...   \n",
       "3  [{\"expirationRequirement\":\"rememberMultifactorAuthenticationOnTrustedDevices\",\"detail\":\"Remember...   \n",
       "4                                                                                                   []   \n",
       "\n",
       "  AutonomousSystemNumber AuthenticationProtocol CrossTenantAccessType  \\\n",
       "0                   7018                   none      b2bCollaboration   \n",
       "1                   7018                   none      b2bCollaboration   \n",
       "2                   5089                   none                  none   \n",
       "3                   5650                   none      b2bCollaboration   \n",
       "4                   7018                   none      b2bCollaboration   \n",
       "\n",
       "  AppliedConditionalAccessPolicies RiskLevel        Type  Result  \\\n",
       "0                                             SigninLogs  Sucess   \n",
       "1                                             SigninLogs  Sucess   \n",
       "2                                             SigninLogs  Sucess   \n",
       "3                                             SigninLogs  Sucess   \n",
       "4                                             SigninLogs  Sucess   \n",
       "\n",
       "             Latitude            Longitude  \n",
       "0   32.37963104248047   -86.29824829101563  \n",
       "1   32.37963104248047   -86.29824829101563  \n",
       "2  51.445831298828128  -0.9697200059890748  \n",
       "3   33.01533889770508   -97.06397247314452  \n",
       "4   32.37963104248047   -86.29824829101563  \n",
       "\n",
       "[5 rows x 79 columns]"
      ]
     },
     "execution_count": 9,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df = qry_prov.Azure.list_all_signins_geo()\n",
    "df.head()"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Some queries require parameters such as a account or host name to search for results in."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>TenantId</th>\n",
       "      <th>Application</th>\n",
       "      <th>UserDomain</th>\n",
       "      <th>Activity</th>\n",
       "      <th>UserAgent</th>\n",
       "      <th>RecordType</th>\n",
       "      <th>TimeGenerated</th>\n",
       "      <th>Operation</th>\n",
       "      <th>OrganizationId</th>\n",
       "      <th>OrganizationId_</th>\n",
       "      <th>UserType</th>\n",
       "      <th>UserKey</th>\n",
       "      <th>OfficeWorkload</th>\n",
       "      <th>ResultStatus</th>\n",
       "      <th>ResultReasonType</th>\n",
       "      <th>OfficeObjectId</th>\n",
       "      <th>UserId</th>\n",
       "      <th>UserId_</th>\n",
       "      <th>ClientIP</th>\n",
       "      <th>ClientIP_</th>\n",
       "      <th>Scope</th>\n",
       "      <th>Site_</th>\n",
       "      <th>ItemType</th>\n",
       "      <th>EventSource</th>\n",
       "      <th>Source_Name</th>\n",
       "      <th>...</th>\n",
       "      <th>TabType</th>\n",
       "      <th>Name</th>\n",
       "      <th>OldValue</th>\n",
       "      <th>NewValue</th>\n",
       "      <th>ItemName</th>\n",
       "      <th>ChatThreadId</th>\n",
       "      <th>ChatName</th>\n",
       "      <th>CommunicationType</th>\n",
       "      <th>AADGroupId</th>\n",
       "      <th>AddOnGuid</th>\n",
       "      <th>AppDistributionMode</th>\n",
       "      <th>TargetUserId</th>\n",
       "      <th>OperationScope</th>\n",
       "      <th>AzureADAppId</th>\n",
       "      <th>OperationProperties</th>\n",
       "      <th>AppId</th>\n",
       "      <th>ClientAppId</th>\n",
       "      <th>ApplicationId</th>\n",
       "      <th>SRPolicyId</th>\n",
       "      <th>SRPolicyName</th>\n",
       "      <th>SRRuleMatchDetails</th>\n",
       "      <th>IsManagedDevice</th>\n",
       "      <th>ActorContextId_</th>\n",
       "      <th>Type</th>\n",
       "      <th>_ResourceId</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>8ecf8077-cf51-4820-aadd-14040956f35d</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>ExchangeItem</td>\n",
       "      <td>2023-06-15 02:04:29+00:00</td>\n",
       "      <td>Send</td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>Regular</td>\n",
       "      <td>1003200160C8B403</td>\n",
       "      <td>Exchange</td>\n",
       "      <td>Succeeded</td>\n",
       "      <td>Succeeded</td>\n",
       "      <td></td>\n",
       "      <td>KDickens@seccxp.ninja</td>\n",
       "      <td>KDickens@seccxp.ninja</td>\n",
       "      <td>20.190.142.41</td>\n",
       "      <td>20.190.142.41</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>...</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>None</td>\n",
       "      <td>00000003-0000-0000-c000-000000000000</td>\n",
       "      <td>d73513d5-ad2e-46c2-a6e9-89a11b7704bb</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>None</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td>OfficeActivity</td>\n",
       "      <td></td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>8ecf8077-cf51-4820-aadd-14040956f35d</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>50</td>\n",
       "      <td>2023-06-15 08:23:15+00:00</td>\n",
       "      <td>MailItemsAccessed</td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>Regular</td>\n",
       "      <td>1003200160C8B403</td>\n",
       "      <td>Exchange</td>\n",
       "      <td>Succeeded</td>\n",
       "      <td>Succeeded</td>\n",
       "      <td></td>\n",
       "      <td>KDickens@seccxp.ninja</td>\n",
       "      <td>KDickens@seccxp.ninja</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>...</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>[{\"Name\":\"MailAccessType\",\"Value\":\"Bind\"},{\"Name\":\"IsThrottled\",\"Value\":\"False\"}]</td>\n",
       "      <td>4787c7ff-7cea-43db-8d0d-919f15c6354b</td>\n",
       "      <td>4787c7ff-7cea-43db-8d0d-919f15c6354b</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>None</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td>OfficeActivity</td>\n",
       "      <td></td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>8ecf8077-cf51-4820-aadd-14040956f35d</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>ExchangeItem</td>\n",
       "      <td>2023-06-15 08:49:08+00:00</td>\n",
       "      <td>Send</td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>Regular</td>\n",
       "      <td>1003200160C8B403</td>\n",
       "      <td>Exchange</td>\n",
       "      <td>Succeeded</td>\n",
       "      <td>Succeeded</td>\n",
       "      <td></td>\n",
       "      <td>KDickens@seccxp.ninja</td>\n",
       "      <td>KDickens@seccxp.ninja</td>\n",
       "      <td>20.190.142.40</td>\n",
       "      <td>20.190.142.40</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>...</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>None</td>\n",
       "      <td>00000003-0000-0000-c000-000000000000</td>\n",
       "      <td>d73513d5-ad2e-46c2-a6e9-89a11b7704bb</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>None</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td>OfficeActivity</td>\n",
       "      <td></td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>8ecf8077-cf51-4820-aadd-14040956f35d</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>50</td>\n",
       "      <td>2023-06-15 08:49:18+00:00</td>\n",
       "      <td>MailItemsAccessed</td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>Regular</td>\n",
       "      <td>1003200160C8B403</td>\n",
       "      <td>Exchange</td>\n",
       "      <td>Succeeded</td>\n",
       "      <td>Succeeded</td>\n",
       "      <td></td>\n",
       "      <td>KDickens@seccxp.ninja</td>\n",
       "      <td>KDickens@seccxp.ninja</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>...</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>[{\"Name\":\"MailAccessType\",\"Value\":\"Bind\"},{\"Name\":\"IsThrottled\",\"Value\":\"False\"}]</td>\n",
       "      <td>4787c7ff-7cea-43db-8d0d-919f15c6354b</td>\n",
       "      <td>4787c7ff-7cea-43db-8d0d-919f15c6354b</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>None</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td>OfficeActivity</td>\n",
       "      <td></td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>8ecf8077-cf51-4820-aadd-14040956f35d</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>50</td>\n",
       "      <td>2023-06-15 08:49:09+00:00</td>\n",
       "      <td>MailItemsAccessed</td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>4b2462a4-bbee-495a-a0e1-f23ae524cc9c</td>\n",
       "      <td>Regular</td>\n",
       "      <td>1003200160C8B403</td>\n",
       "      <td>Exchange</td>\n",
       "      <td>Succeeded</td>\n",
       "      <td>Succeeded</td>\n",
       "      <td></td>\n",
       "      <td>KDickens@seccxp.ninja</td>\n",
       "      <td>KDickens@seccxp.ninja</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>...</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>[{\"Name\":\"MailAccessType\",\"Value\":\"Bind\"},{\"Name\":\"IsThrottled\",\"Value\":\"False\"}]</td>\n",
       "      <td>13937bba-652e-4c46-b222-3003f4d1ff97</td>\n",
       "      <td>13937bba-652e-4c46-b222-3003f4d1ff97</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>None</td>\n",
       "      <td>None</td>\n",
       "      <td></td>\n",
       "      <td>OfficeActivity</td>\n",
       "      <td></td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>5 rows × 138 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "                               TenantId Application UserDomain Activity  \\\n",
       "0  8ecf8077-cf51-4820-aadd-14040956f35d                                   \n",
       "1  8ecf8077-cf51-4820-aadd-14040956f35d                                   \n",
       "2  8ecf8077-cf51-4820-aadd-14040956f35d                                   \n",
       "3  8ecf8077-cf51-4820-aadd-14040956f35d                                   \n",
       "4  8ecf8077-cf51-4820-aadd-14040956f35d                                   \n",
       "\n",
       "  UserAgent    RecordType             TimeGenerated          Operation  \\\n",
       "0            ExchangeItem 2023-06-15 02:04:29+00:00               Send   \n",
       "1                      50 2023-06-15 08:23:15+00:00  MailItemsAccessed   \n",
       "2            ExchangeItem 2023-06-15 08:49:08+00:00               Send   \n",
       "3                      50 2023-06-15 08:49:18+00:00  MailItemsAccessed   \n",
       "4                      50 2023-06-15 08:49:09+00:00  MailItemsAccessed   \n",
       "\n",
       "                         OrganizationId                       OrganizationId_  \\\n",
       "0  4b2462a4-bbee-495a-a0e1-f23ae524cc9c  4b2462a4-bbee-495a-a0e1-f23ae524cc9c   \n",
       "1  4b2462a4-bbee-495a-a0e1-f23ae524cc9c  4b2462a4-bbee-495a-a0e1-f23ae524cc9c   \n",
       "2  4b2462a4-bbee-495a-a0e1-f23ae524cc9c  4b2462a4-bbee-495a-a0e1-f23ae524cc9c   \n",
       "3  4b2462a4-bbee-495a-a0e1-f23ae524cc9c  4b2462a4-bbee-495a-a0e1-f23ae524cc9c   \n",
       "4  4b2462a4-bbee-495a-a0e1-f23ae524cc9c  4b2462a4-bbee-495a-a0e1-f23ae524cc9c   \n",
       "\n",
       "  UserType           UserKey OfficeWorkload ResultStatus ResultReasonType  \\\n",
       "0  Regular  1003200160C8B403       Exchange    Succeeded        Succeeded   \n",
       "1  Regular  1003200160C8B403       Exchange    Succeeded        Succeeded   \n",
       "2  Regular  1003200160C8B403       Exchange    Succeeded        Succeeded   \n",
       "3  Regular  1003200160C8B403       Exchange    Succeeded        Succeeded   \n",
       "4  Regular  1003200160C8B403       Exchange    Succeeded        Succeeded   \n",
       "\n",
       "  OfficeObjectId                 UserId                UserId_       ClientIP  \\\n",
       "0                 KDickens@seccxp.ninja  KDickens@seccxp.ninja  20.190.142.41   \n",
       "1                 KDickens@seccxp.ninja  KDickens@seccxp.ninja                  \n",
       "2                 KDickens@seccxp.ninja  KDickens@seccxp.ninja  20.190.142.40   \n",
       "3                 KDickens@seccxp.ninja  KDickens@seccxp.ninja                  \n",
       "4                 KDickens@seccxp.ninja  KDickens@seccxp.ninja                  \n",
       "\n",
       "       ClientIP_ Scope Site_ ItemType EventSource Source_Name  ... TabType  \\\n",
       "0  20.190.142.41                                               ...           \n",
       "1                                                              ...           \n",
       "2  20.190.142.40                                               ...           \n",
       "3                                                              ...           \n",
       "4                                                              ...           \n",
       "\n",
       "  Name OldValue NewValue ItemName ChatThreadId ChatName CommunicationType  \\\n",
       "0                                                                           \n",
       "1                                                                           \n",
       "2                                                                           \n",
       "3                                                                           \n",
       "4                                                                           \n",
       "\n",
       "  AADGroupId AddOnGuid AppDistributionMode TargetUserId OperationScope  \\\n",
       "0                                                                        \n",
       "1                                                                        \n",
       "2                                                                        \n",
       "3                                                                        \n",
       "4                                                                        \n",
       "\n",
       "  AzureADAppId  \\\n",
       "0                \n",
       "1                \n",
       "2                \n",
       "3                \n",
       "4                \n",
       "\n",
       "                                                                 OperationProperties  \\\n",
       "0                                                                               None   \n",
       "1  [{\"Name\":\"MailAccessType\",\"Value\":\"Bind\"},{\"Name\":\"IsThrottled\",\"Value\":\"False\"}]   \n",
       "2                                                                               None   \n",
       "3  [{\"Name\":\"MailAccessType\",\"Value\":\"Bind\"},{\"Name\":\"IsThrottled\",\"Value\":\"False\"}]   \n",
       "4  [{\"Name\":\"MailAccessType\",\"Value\":\"Bind\"},{\"Name\":\"IsThrottled\",\"Value\":\"False\"}]   \n",
       "\n",
       "                                  AppId                           ClientAppId  \\\n",
       "0  00000003-0000-0000-c000-000000000000  d73513d5-ad2e-46c2-a6e9-89a11b7704bb   \n",
       "1  4787c7ff-7cea-43db-8d0d-919f15c6354b  4787c7ff-7cea-43db-8d0d-919f15c6354b   \n",
       "2  00000003-0000-0000-c000-000000000000  d73513d5-ad2e-46c2-a6e9-89a11b7704bb   \n",
       "3  4787c7ff-7cea-43db-8d0d-919f15c6354b  4787c7ff-7cea-43db-8d0d-919f15c6354b   \n",
       "4  13937bba-652e-4c46-b222-3003f4d1ff97  13937bba-652e-4c46-b222-3003f4d1ff97   \n",
       "\n",
       "  ApplicationId SRPolicyId SRPolicyName SRRuleMatchDetails IsManagedDevice  \\\n",
       "0                                                     None            None   \n",
       "1                                                     None            None   \n",
       "2                                                     None            None   \n",
       "3                                                     None            None   \n",
       "4                                                     None            None   \n",
       "\n",
       "   ActorContextId_            Type _ResourceId  \n",
       "0                   OfficeActivity              \n",
       "1                   OfficeActivity              \n",
       "2                   OfficeActivity              \n",
       "3                   OfficeActivity              \n",
       "4                   OfficeActivity              \n",
       "\n",
       "[5 rows x 138 columns]"
      ]
     },
     "execution_count": 10,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "office_activity = qry_prov.Office365.list_activity_for_account(account_name=\"KDickens@seccxp.ninja\")\n",
    "office_activity.head()"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Debug Tip\n",
    "\n",
    "You can get a clearer view of what a built in query actually is by adding the `\"print\"` keyword as the first parameter when calling it.<br>\n",
    "This will printed the parameterized query rather than run it. The printed query will include any parameter values you passed it."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "(' let accountName = \"KDickens@seccxp.ninja\"; let account = case( accountName '\n",
      " 'has \"@\", tostring(split(accountName, \"@\")[0]), accountName has \"\\\\\\\\\", '\n",
      " 'tostring(split(accountName, \"\\\\\\\\\")[1]), accountName ); OfficeActivity | '\n",
      " 'where TimeGenerated >= datetime(2023-06-14T21:45:34.822294Z) | where '\n",
      " 'TimeGenerated <= datetime(2023-06-16T21:45:34.822294Z) | where UserId has '\n",
      " 'accountName ')\n"
     ]
    }
   ],
   "source": [
    "qry_prov.Office365.list_activity_for_account(\"print\", account_name=\"KDickens@seccxp.ninja\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"> let accountName = <span style=\"color: #008000; text-decoration-color: #008000\">\"KDickens@seccxp.ninja\"</span>; let account = <span style=\"color: #800080; text-decoration-color: #800080; font-weight: bold\">case</span><span style=\"font-weight: bold\">(</span> accountName has <span style=\"color: #008000; text-decoration-color: #008000\">\"@\"</span>, <span style=\"color: #800080; text-decoration-color: #800080; font-weight: bold\">tostring</span><span style=\"font-weight: bold\">(</span><span style=\"color: #800080; text-decoration-color: #800080; font-weight: bold\">split</span><span style=\"font-weight: bold\">(</span>accountName, \n",
       "<span style=\"color: #008000; text-decoration-color: #008000\">\"@\"</span><span style=\"font-weight: bold\">)[</span><span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0</span><span style=\"font-weight: bold\">])</span>, accountName has <span style=\"color: #008000; text-decoration-color: #008000\">\"\\\\\", tostring(split(accountName, \"</span>\\\\\"<span style=\"font-weight: bold\">)[</span><span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1</span><span style=\"font-weight: bold\">])</span>, accountName <span style=\"font-weight: bold\">)</span>; OfficeActivity | where \n",
       "TimeGenerated &gt;= <span style=\"color: #800080; text-decoration-color: #800080; font-weight: bold\">datetime</span><span style=\"font-weight: bold\">(</span><span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2023</span>-<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">06</span>-14T<span style=\"color: #00ff00; text-decoration-color: #00ff00; font-weight: bold\">21:45:34</span>.822294Z<span style=\"font-weight: bold\">)</span> | where TimeGenerated &lt;= \n",
       "<span style=\"color: #800080; text-decoration-color: #800080; font-weight: bold\">datetime</span><span style=\"font-weight: bold\">(</span><span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2023</span>-<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">06</span>-16T<span style=\"color: #00ff00; text-decoration-color: #00ff00; font-weight: bold\">21:45:34</span>.822294Z<span style=\"font-weight: bold\">)</span> | where UserId has accountName \n",
       "</pre>\n"
      ],
      "text/plain": [
       " let accountName = \u001b[32m\"KDickens@seccxp.ninja\"\u001b[0m; let account = \u001b[1;35mcase\u001b[0m\u001b[1m(\u001b[0m accountName has \u001b[32m\"@\"\u001b[0m, \u001b[1;35mtostring\u001b[0m\u001b[1m(\u001b[0m\u001b[1;35msplit\u001b[0m\u001b[1m(\u001b[0maccountName, \n",
       "\u001b[32m\"@\"\u001b[0m\u001b[1m)\u001b[0m\u001b[1m[\u001b[0m\u001b[1;36m0\u001b[0m\u001b[1m]\u001b[0m\u001b[1m)\u001b[0m, accountName has \u001b[32m\"\\\\\", tostring\u001b[0m\u001b[32m(\u001b[0m\u001b[32msplit\u001b[0m\u001b[32m(\u001b[0m\u001b[32maccountName, \"\u001b[0m\\\\\"\u001b[1m)\u001b[0m\u001b[1m[\u001b[0m\u001b[1;36m1\u001b[0m\u001b[1m]\u001b[0m\u001b[1m)\u001b[0m, accountName \u001b[1m)\u001b[0m; OfficeActivity | where \n",
       "TimeGenerated >= \u001b[1;35mdatetime\u001b[0m\u001b[1m(\u001b[0m\u001b[1;36m2023\u001b[0m-\u001b[1;36m06\u001b[0m-14T\u001b[1;92m21:45:34\u001b[0m.822294Z\u001b[1m)\u001b[0m | where TimeGenerated <= \n",
       "\u001b[1;35mdatetime\u001b[0m\u001b[1m(\u001b[0m\u001b[1;36m2023\u001b[0m-\u001b[1;36m06\u001b[0m-16T\u001b[1;92m21:45:34\u001b[0m.822294Z\u001b[1m)\u001b[0m | where UserId has accountName \n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "from rich import print as rprint\n",
    "rprint(qry_prov.Office365.list_activity_for_account(\"print\", account_name=\"KDickens@seccxp.ninja\"))"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Extending queries with the `add_query_items` parameter\n",
    "\n",
    "We can also customize built in queries with by adding query items to them."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "office_activity_filtered = qry_prov.Office365.list_activity_for_account(\n",
    "    account_name=\"KDickens@seccxp.ninja\",\n",
    "    add_query_items=\"| where Operation != 'MailItemsAccessed'\"\n",
    ")\n",
    "office_activity_filtered.head()"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "You can also add your own built in queries by specifying them in a yaml file and adding the required path to your msticpyconfig.yaml file. "
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "We can also use `exec_query` to run our own queries."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "query = \"OfficeActivity | where TimeGenerated > ago(7d) | where UserId =~ 'KDickens@seccxp.ninja' | summarize count() by Operation\"\n",
    "custom_query_df = qry_prov.exec_query(query)\n",
    "custom_query_df"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "When writing our own queries for a Log Analytics (or Kusto) based data source we can check the schema of any table in our connected workspace with `.schema`.<br>\n",
    "This will return JSON data with all the tables, their column names, and the data type of each field."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "{'AdditionalInformation': 'string',\n",
       " 'AzureDeploymentID': 'string',\n",
       " 'Computer': 'string',\n",
       " 'Confidence': 'string',\n",
       " 'Date': 'string',\n",
       " 'Description': 'string',\n",
       " 'FileOffset': 'int',\n",
       " 'FileUri': 'string',\n",
       " 'FirstReportedDateTime': 'string',\n",
       " 'IndicatorThreatType': 'string',\n",
       " 'IsActive': 'string',\n",
       " 'LastReportedDateTime': 'string',\n",
       " 'MG': 'guid',\n",
       " 'MaliciousIP': 'string',\n",
       " 'ManagementGroupName': 'string',\n",
       " 'RemoteIPCountry': 'string',\n",
       " 'RemoteIPLatitude': 'real',\n",
       " 'RemoteIPLongitude': 'real',\n",
       " 'ReportReferenceLink': 'string',\n",
       " 'Role': 'string',\n",
       " 'RoleInstance': 'string',\n",
       " 'Severity': 'int',\n",
       " 'SourceSystem': 'string',\n",
       " 'StorageAccount': 'string',\n",
       " 'TLPLevel': 'string',\n",
       " 'TenantId': 'guid',\n",
       " 'Time': 'string',\n",
       " 'TimeGenerated': 'datetime',\n",
       " 'TimeTaken': 'long',\n",
       " 'cIP': 'string',\n",
       " 'csBytes': 'long',\n",
       " 'csCookie': 'string',\n",
       " 'csHost': 'string',\n",
       " 'csMethod': 'string',\n",
       " 'csReferer': 'string',\n",
       " 'csUriQuery': 'string',\n",
       " 'csUriStem': 'string',\n",
       " 'csUserAgent': 'string',\n",
       " 'csUserName': 'string',\n",
       " 'csVersion': 'string',\n",
       " 'sComputerName': 'string',\n",
       " 'sIP': 'string',\n",
       " 'sPort': 'int',\n",
       " 'sSiteName': 'string',\n",
       " 'scBytes': 'long',\n",
       " 'scStatus': 'string',\n",
       " 'scSubStatus': 'string',\n",
       " 'scWin32Status': 'string'}"
      ]
     },
     "execution_count": 19,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "qry_prov.schema['W3CIISLog']"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "---\n",
    "**Extra**\n",
    "\n",
    "It is also possible to add your own queries to the built in queries in MSTICPy.<br>\n",
    "See this document in our ReadTheDocs documentation\n",
    "In addition our documentation shows how to structure the required files and reference them in your configuration.<br>\n",
    "Adding queries to MSTICPy: https://msticpy.readthedocs.io/en/latest/extending/Queries.html<br>\n",
    "Also see this notebook: https://github.com/ianhelle/pycon2021/blob/main/Extending-MSTICPy.ipynb<br>\n"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## <a style=\"border: solid; padding:5pt; color:black; background-color:#309030\">1st Exercise - Run a query</a>\n",
    "\n",
    "Execute a query against the created `qry_prov`. This can be a built in query or a custom query - its up to you.\n",
    "\n",
    "<details>\n",
    "<summary>Hints...</summary>\n",
    "<ul>\n",
    "<li>If you add \"print\" as a parameter when calling a query it will print out the query rather than executing it.</li>\n",
    "<li>qry_prov.browse() will show you the code need to run each query in there</li>\n",
    "</ul>\n",
    "</details>\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "# <a style=\"border: solid; padding:5pt; color:black; background-color:#909090\">Kusto</a>\n",
    "\n",
    "---\n",
    "\n",
    "Sentinel isn't the only data provider available and we have plenty more that we can use to connect to.<br>\n",
    "Kusto is a popular data source for a lot of uses.\n",
    "\n",
    "We added Kusto cluster to our `msticpyconfig.yaml` file in the previous session. We will use this Kusto cluster (`https://msticpytraining.eastus.kusto.windows.net`)."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "from msticpy.config import  MpConfigEdit\n",
    "\n",
    "MpConfigEdit()"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "\n",
    "\n",
    "## <a style=\"border: solid; padding:5pt; color:black; background-color:#309030\">2nd Exercise - Kusto</a>\n",
    "\n",
    "1. Connect to the Kusto cluster https://msticpytraining.eastus.kusto.windows.net/ and the `msticpydata` database. <br>\n",
    "2. Run a query to understand the schema of the Syslog table and get some data\n",
    "\n",
    "\n",
    "<details>\n",
    "<summary>Hints...</summary>\n",
    "<ul>\n",
    "<li>You need to specify a cluster to connect to - the cluster can be specified as:\n",
    "    <ul>\n",
    "    <li>A cluster friendly name - the entry name in our configuration</li>\n",
    "    <li>The full URL</li>\n",
    "    <li>Just the host part of the URL - e.g. \"msticpytraining\"</li>\n",
    "    </ul>\n",
    "</li>\n",
    "<li>We gave the Kusto cluster the short name \"Kusto-Firecon23\" in our config.</li>\n",
    "<li>The `cluster` and `database` parameters are key here if not using instance.</li>\n",
    "<li>https://msticpy.readthedocs.io/en/latest/data_acquisition/DataProv-Kusto-New.html has the details you need</li>\n",
    "<li>`Syslog | getschema` returns the schema of the Syslog table.</li>\n",
    "<li>You can specify the default database in the 'connect' call (database=\"msticpydata\") or passing the same parameter\n",
    "to 'exec_query()'\n",
    "<li>\n",
    "<li>You can also get the schema using the qry_prov.get_database_schema() function\n",
    "</ul>\n",
    "</details>\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 32,
   "metadata": {},
   "outputs": [],
   "source": [
    "kusto_prov = mp.QueryProvider(\"Kusto_New\")\n",
    "...\n"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "There are also some helper functions in the Kusto query provider\n",
    "to retrieve the schema:\n",
    "- `qry_prov.get_database_schema(<database>)`\n",
    "- `qry_prov.schema[<TableName>]`"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 39,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "{'Column1': 'Int64',\n",
      " 'Computer': 'String',\n",
      " 'EventTime': 'DateTime',\n",
      " 'Facility': 'String',\n",
      " 'HostIP': 'String',\n",
      " 'HostName': 'String',\n",
      " 'MG': 'Guid',\n",
      " 'ProcessID': 'String',\n",
      " 'ProcessName': 'String',\n",
      " 'SeverityLevel': 'String',\n",
      " 'SourceSystem': 'String',\n",
      " 'SyslogMessage': 'String',\n",
      " 'TenantId': 'Guid',\n",
      " 'TimeGenerated': 'DateTime',\n",
      " 'Type': 'String',\n",
      " '_ResourceId': 'String'}\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "{'Column1': 'Int64',\n",
       " 'TenantId': 'Guid',\n",
       " 'SourceSystem': 'String',\n",
       " 'TimeGenerated': 'DateTime',\n",
       " 'Computer': 'String',\n",
       " 'EventTime': 'DateTime',\n",
       " 'Facility': 'String',\n",
       " 'HostName': 'String',\n",
       " 'SeverityLevel': 'String',\n",
       " 'SyslogMessage': 'String',\n",
       " 'ProcessID': 'String',\n",
       " 'HostIP': 'String',\n",
       " 'ProcessName': 'String',\n",
       " 'MG': 'Guid',\n",
       " 'Type': 'String',\n",
       " '_ResourceId': 'String'}"
      ]
     },
     "execution_count": 39,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "pprint(kusto_prov.get_database_schema(\"msticpydata\")[\"Syslog\"])\n",
    "kusto_prov.set_database(\"msticpydata\")\n",
    "kusto_prov.schema[\"Syslog\"]"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "# <a style=\"border: solid; padding:5pt; color:black; background-color:#909090\">Microsoft Defender</a>\n",
    "\n",
    "---\n",
    "Some data providers have different connection options, for example the Microsoft Defender for Endpoint and Microsoft 365 Defender APIs require a client application to handle authentication.<br>\n",
    "You can pass in these application details when connecting but if we are using an application secret its better to keep these in KeyVault and reference them in our config file."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 40,
   "metadata": {},
   "outputs": [],
   "source": [
    "# if you didn't run these earlier in the notebook\n",
    "# import msticpy as mp \n",
    "# mp.init_notebook()"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "You can store multiple instances in your config file. To select what instance to connect to use the `instance` keyword.<br>\n",
    "In this example we will connect to our pre-configured Training instance.\n",
    "\n",
    "Ref: https://msticpy.readthedocs.io/en/latest/data_acquisition/DataProv-MSDefender.html#connecting-to-m365-defender"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
<<<<<<< HEAD
   "outputs": [
    {
     "data": {
      "text/html": [
       "\n",
       "        <style>\n",
       "            div.solid {border: thin solid black; padding:10px;}\n",
       "            p.title {background-color:Tomato; padding:5px;}\n",
       "            ul.circle {list-style-type: circle;}\n",
       "            div.indent {text-indent: 20px; padding: 0px}\n",
       "        </style>\n",
       "        <div class='solid'><h3><p class='title'>MsticpyConnectionError - we've hit an error while running</p></h3>Could not obtain access token - AADSTS7000222: The provided client secret keys for app '01a3feba-14bb-445d-a192-2e9544d1add3' are expired. Visit the Azure portal to create new keys for your app: https://aka.ms/NewClientSecret, or consider using certificate credentials for added security: https://aka.ms/certCreds.\r<br>Trace ID: 3898406a-ecc7-4207-a018-952298e16a00\r<br>Correlation ID: 86e24ddb-f3dc-47de-abf4-9e302202d621\r<br>Timestamp: 2023-06-15 23:40:43Z<br><br>For more help on fixing this error see:<br><ul class='circle'><li><a href='https://msticpy.readthedocs.io/en/latest/data_acquisition/DataProviders.html' target='_blank' rel='noopener noreferrer'>DataProviders</a></li></ul><summary>Additional context<details><div class='indent'>Stack:</div><div class='indent'>  File \"f:\\anaconda\\envs\\firecon23\\Lib\\site-packages\\IPython\\core\\interactiveshell.py\", line 3508, in run_code\n",
       "    exec(code_obj, self.user_global_ns, self.user_ns)\n",
       "</div><div class='indent'>  File \"C:\\Users\\Ian\\AppData\\Local\\Temp\\ipykernel_58412\\4126588627.py\", line 2, in <module>\n",
       "    defender_prov.connect()\n",
       "</div><div class='indent'>  File \"f:\\anaconda\\envs\\firecon23\\Lib\\site-packages\\msticpy\\data\\core\\data_providers.py\", line 182, in connect\n",
       "    self._query_provider.connect(connection_str=connection_str, **kwargs)\n",
       "</div><div class='indent'>  File \"f:\\anaconda\\envs\\firecon23\\Lib\\site-packages\\msticpy\\data\\drivers\\odata_driver.py\", line 172, in connect\n",
       "    raise MsticpyConnectionError(\n",
       "</div><div class='indent'>  File \"f:\\anaconda\\envs\\firecon23\\Lib\\site-packages\\msticpy\\common\\exceptions.py\", line 119, in __init__\n",
       "    stack=traceback.format_stack(limit=5),\n"
      ],
      "text/plain": [
       "msticpy.common.exceptions.MsticpyConnectionError(\"we've hit an error while running\",\n",
       "                                                 \"Could not obtain access token - AADSTS7000222: The provided client secret keys for app '01a3feba-14bb-445d-a192-2e9544d1add3' are expired. Visit the Azure portal to create new keys for your app: https://aka.ms/NewClientSecret, or consider using certificate credentials for added security: https://aka.ms/certCreds.\\r\\nTrace ID: 3898406a-ecc7-4207-a018-952298e16a00\\r\\nCorrelation ID: 86e24ddb-f3dc-47de-abf4-9e302202d621\\r\\nTimestamp: 2023-06-15 23:40:43Z\",\n",
       "                                                 ('DataProviders',\n",
       "                                                  'https://msticpy.readthedocs.io/en/latest/data_acquisition/DataProviders.html'))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
=======
   "outputs": [],
>>>>>>> 46b5ee4 (Removing reference to secret in notebook (although no actual secret))
   "source": [
    "defender_prov = mp.QueryProvider(\"M365D\")\n",
    "defender_prov.connect()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "defender_prov.browse()"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "We can also execute our own queries in the same format as with the other providers."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "defender_prov.exec_query(\"DeviceInfo | take 10\")"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## <a style=\"border: solid; padding:5pt; color:black; background-color:#309030\">3rd Exercise - Defender Investigation</a>\n",
    "\n",
    "1. Find the remote IP address associated MDE connections to the URL 'davlenwindows.com' on 10/14/2022\n",
    "2. Find all the hosts that have connected to that URL address since 10/01/2022\n",
    "3. Get the file hash of the initiating process for these connections on 10/14/2022 and get all the files names associated with this hash on that day\n",
    "\n",
    "\n",
    "<details>\n",
    "<summary>Hints...</summary>\n",
    "<ul>\n",
    "<li>You can do this with built in queries or your own queries</li>\n",
    "<li>The Query Browser is your friend `qry_prov.browse()`</li>\n",
    "<li>Don't forget you can use add_query_items to add to the built in queries to customize the returned data.</li>\n",
    "</ul>\n",
    "</details>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "# <a style=\"border: solid; padding:5pt; color:black; background-color:#909090\">Azure Resource Graph</a>\n",
    "\n",
    "---\n",
    "\n",
    "\n",
    "The Azure Resource graph provides a way to get details about Azure Resources using KQL, this is something that is really useful to adding context during an investigation.<br>\n",
    "Below we are going to load our Resource Graph provider and connect using the Azure CLI tokens that we generated earlier."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 42,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Connected\n"
     ]
    }
   ],
   "source": [
    "res_qry_prov = mp.QueryProvider(\"ResourceGraph\")\n",
    "res_qry_prov.connect(auth_methods=[\"cli\"])"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "As with the other providers we can use in built queries or write our own custom queries. Hopefully by now you are familiar with this model and concept."
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "\n",
    "## <a style=\"border: solid; padding:5pt; color:black; background-color:#309030\">4th Exercise - Azure Resource Graph</a>\n",
    "\n",
    " 1 . Find out how many KeyVaults that you have access to. <br>\n",
    " 2. What resources exist in the msticpy resource group.<br>\n",
    " 3. Find the Key Vault that is detailed in your msticpyconfig.yaml file<br>\n",
    "\n",
    "\n",
    "<details>\n",
    "<summary>Hints...</summary>\n",
    "<ul>\n",
    "<li>All data in the Resource Graph is in the Resources table</li>\n",
    "<li>https://learn.microsoft.com/en-us/azure/governance/resource-graph/samples/starter?tabs=azure-cli gives you some query examples</li>\n",
    "<li>`Resources | where type =~ 'microsoft.keyvault/vaults' will show you all Keyvaults</li>\n",
    "<li>You will need to use .exec_query here</li>\n",
    "</ul>\n",
    "</details>\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 48,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>type</th>\n",
       "      <th>kind</th>\n",
       "      <th>count_</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>microsoft.keyvault/vaults</td>\n",
       "      <td></td>\n",
       "      <td>1246</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>microsoft.compute/sshpublickeys</td>\n",
       "      <td></td>\n",
       "      <td>253</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                              type kind  count_\n",
       "0        microsoft.keyvault/vaults         1246\n",
       "1  microsoft.compute/sshpublickeys          253"
      ]
     },
     "execution_count": 48,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "res_qry_prov.exec_query(\"Resources | where type contains 'key' | summarize count() by type, kind | order by count_ desc\")"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "\n",
    "## <a style=\"border: solid; padding:5pt; color:black; background-color:#309030\">Bonus Exercise - Azure Resource Graph</a>\n",
    "\n",
    "CDOC received a report that the VM MSTIC-DSVM has been compromised. You need to answer the following questions:\n",
    "1. Is this a real host?\n",
    "2. Is it currently in use?\n",
    "3. What IPs is it associated with?\n",
    "4. Is it a production host?\n",
    "5. What other resources might have been compromised?\n",
    "6. Are there any users we can contact about this host?\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 52,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>name</th>\n",
       "      <th>type</th>\n",
       "      <th>tenantId</th>\n",
       "      <th>kind</th>\n",
       "      <th>location</th>\n",
       "      <th>resourceGroup</th>\n",
       "      <th>subscriptionId</th>\n",
       "      <th>managedBy</th>\n",
       "      <th>properties.provisioningState</th>\n",
       "      <th>properties.timeCreated</th>\n",
       "      <th>properties.networkProfile.networkInterfaces</th>\n",
       "      <th>properties.osProfile.computerName</th>\n",
       "      <th>properties.osProfile.allowExtensionOperations</th>\n",
       "      <th>properties.osProfile.secrets</th>\n",
       "      <th>properties.osProfile.adminUsername</th>\n",
       "      <th>properties.storageProfile.imageReference.publisher</th>\n",
       "      <th>properties.storageProfile.imageReference.exactVersion</th>\n",
       "      <th>properties.storageProfile.imageReference.version</th>\n",
       "      <th>properties.storageProfile.imageReference.sku</th>\n",
       "      <th>properties.storageProfile.imageReference.offer</th>\n",
       "      <th>properties.storageProfile.dataDisks</th>\n",
       "      <th>properties.storageProfile.osDisk.name</th>\n",
       "      <th>properties.storageProfile.osDisk.createOption</th>\n",
       "      <th>properties.storageProfile.osDisk.osType</th>\n",
       "      <th>properties.storageProfile.osDisk.managedDisk.id</th>\n",
       "      <th>properties.storageProfile.osDisk.caching</th>\n",
       "      <th>properties.hardwareProfile.vmSize</th>\n",
       "      <th>properties.diagnosticsProfile.bootDiagnostics.enabled</th>\n",
       "      <th>properties.vmId</th>\n",
       "      <th>properties.extended.instanceView.hyperVGeneration</th>\n",
       "      <th>properties.extended.instanceView.powerState.displayStatus</th>\n",
       "      <th>properties.extended.instanceView.powerState.level</th>\n",
       "      <th>properties.extended.instanceView.powerState.code</th>\n",
       "      <th>tags.platformsettings.host_environment.service.platform_optedin_for_rootcerts</th>\n",
       "      <th>tags.azsecpack</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>/subscriptions/40dcc8bf-0478-4f3b-b275-ed0a94f2c013/resourceGroups/ASIHuntOMSWorkspaceRG/provide...</td>\n",
       "      <td>MSTICAlertsWin1</td>\n",
       "      <td>microsoft.compute/virtualmachines</td>\n",
       "      <td>72f988bf-86f1-41af-91ab-2d7cd011db47</td>\n",
       "      <td></td>\n",
       "      <td>eastus</td>\n",
       "      <td>asihuntomsworkspacerg</td>\n",
       "      <td>40dcc8bf-0478-4f3b-b275-ed0a94f2c013</td>\n",
       "      <td></td>\n",
       "      <td>Succeeded</td>\n",
       "      <td>2018-11-12T20:40:06.0459250Z</td>\n",
       "      <td>[{'id': '/subscriptions/40dcc8bf-0478-4f3b-b275-ed0a94f2c013/resourceGroups/ASIHuntOMSWorkspaceR...</td>\n",
       "      <td>MSTICAlertsWin1</td>\n",
       "      <td>True</td>\n",
       "      <td>[]</td>\n",
       "      <td>MSTICAdmin</td>\n",
       "      <td>MicrosoftWindowsServer</td>\n",
       "      <td>2016.127.20181010</td>\n",
       "      <td>latest</td>\n",
       "      <td>2016-Datacenter</td>\n",
       "      <td>WindowsServer</td>\n",
       "      <td>[]</td>\n",
       "      <td>MSTICAlertsWin1_OsDisk_1_52bcecd0dbd54d508de086940988ffe8</td>\n",
       "      <td>FromImage</td>\n",
       "      <td>Windows</td>\n",
       "      <td>/subscriptions/40dcc8bf-0478-4f3b-b275-ed0a94f2c013/resourceGroups/ASIHuntOMSWorkspaceRG/provide...</td>\n",
       "      <td>ReadWrite</td>\n",
       "      <td>Standard_DS2_v2</td>\n",
       "      <td>True</td>\n",
       "      <td>3b8d40a2-33fa-4230-9dc1-794aabdd225c</td>\n",
       "      <td>V1</td>\n",
       "      <td>VM deallocated</td>\n",
       "      <td>Info</td>\n",
       "      <td>PowerState/deallocated</td>\n",
       "      <td>true</td>\n",
       "      <td>nonprod</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>/subscriptions/40dcc8bf-0478-4f3b-b275-ed0a94f2c013/resourceGroups/asihuntomsworkspacerg/provide...</td>\n",
       "      <td>MSTICRHELLXVM</td>\n",
       "      <td>microsoft.compute/virtualmachines</td>\n",
       "      <td>72f988bf-86f1-41af-91ab-2d7cd011db47</td>\n",
       "      <td></td>\n",
       "      <td>eastus</td>\n",
       "      <td>asihuntomsworkspacerg</td>\n",
       "      <td>40dcc8bf-0478-4f3b-b275-ed0a94f2c013</td>\n",
       "      <td></td>\n",
       "      <td>Succeeded</td>\n",
       "      <td>2019-01-15T19:06:40.3178938Z</td>\n",
       "      <td>[{'id': '/subscriptions/40dcc8bf-0478-4f3b-b275-ed0a94f2c013/resourceGroups/ASIHuntOMSWorkspaceR...</td>\n",
       "      <td>MSTICRHELLXVM</td>\n",
       "      <td>True</td>\n",
       "      <td>[]</td>\n",
       "      <td>russmc</td>\n",
       "      <td>RedHat</td>\n",
       "      <td>7.6.2018103108</td>\n",
       "      <td>latest</td>\n",
       "      <td>7-RAW</td>\n",
       "      <td>RHEL</td>\n",
       "      <td>[]</td>\n",
       "      <td>MSTICRHELLXVM_OsDisk_1_a422f94406464badacdb491b39e33efc</td>\n",
       "      <td>FromImage</td>\n",
       "      <td>Linux</td>\n",
       "      <td>/subscriptions/40dcc8bf-0478-4f3b-b275-ed0a94f2c013/resourceGroups/ASIHuntOMSWorkspaceRG/provide...</td>\n",
       "      <td>ReadWrite</td>\n",
       "      <td>Basic_A0</td>\n",
       "      <td>True</td>\n",
       "      <td>ca085263-467b-482f-8603-8faa71a5f054</td>\n",
       "      <td>V1</td>\n",
       "      <td>VM deallocated</td>\n",
       "      <td>Info</td>\n",
       "      <td>PowerState/deallocated</td>\n",
       "      <td>true</td>\n",
       "      <td>nonprod</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>/subscriptions/40dcc8bf-0478-4f3b-b275-ed0a94f2c013/resourceGroups/asihuntomsworkspacerg/provide...</td>\n",
       "      <td>MSTICULXVM</td>\n",
       "      <td>microsoft.compute/virtualmachines</td>\n",
       "      <td>72f988bf-86f1-41af-91ab-2d7cd011db47</td>\n",
       "      <td></td>\n",
       "      <td>eastus2</td>\n",
       "      <td>asihuntomsworkspacerg</td>\n",
       "      <td>40dcc8bf-0478-4f3b-b275-ed0a94f2c013</td>\n",
       "      <td></td>\n",
       "      <td>Succeeded</td>\n",
       "      <td>2019-01-04T18:55:57.6286475Z</td>\n",
       "      <td>[{'id': '/subscriptions/40dcc8bf-0478-4f3b-b275-ed0a94f2c013/resourceGroups/ASIHuntOMSWorkspaceR...</td>\n",
       "      <td>MSTICULXVM</td>\n",
       "      <td>True</td>\n",
       "      <td>[]</td>\n",
       "      <td>russmc</td>\n",
       "      <td>Canonical</td>\n",
       "      <td>18.04.201812060</td>\n",
       "      <td>latest</td>\n",
       "      <td>18.04-LTS</td>\n",
       "      <td>UbuntuServer</td>\n",
       "      <td>[]</td>\n",
       "      <td>MSTICULXVM_OsDisk_1_fecd1b61f61d461e93553b511dd2ec6b</td>\n",
       "      <td>FromImage</td>\n",
       "      <td>Linux</td>\n",
       "      <td>/subscriptions/40dcc8bf-0478-4f3b-b275-ed0a94f2c013/resourceGroups/ASIHuntOMSWorkspaceRG/provide...</td>\n",
       "      <td>ReadWrite</td>\n",
       "      <td>Standard_A0</td>\n",
       "      <td>True</td>\n",
       "      <td>98741e0c-549f-459d-97fd-9c8a3848b71d</td>\n",
       "      <td>V1</td>\n",
       "      <td>VM deallocated</td>\n",
       "      <td>Info</td>\n",
       "      <td>PowerState/deallocated</td>\n",
       "      <td>true</td>\n",
       "      <td>nonprod</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>/subscriptions/8eebd9ad-e271-4989-a796-d60c57655743/resourceGroups/LinuxTestLab/providers/Micros...</td>\n",
       "      <td>MSTICAttacker</td>\n",
       "      <td>microsoft.compute/virtualmachines</td>\n",
       "      <td>72f988bf-86f1-41af-91ab-2d7cd011db47</td>\n",
       "      <td></td>\n",
       "      <td>eastus2</td>\n",
       "      <td>linuxtestlab</td>\n",
       "      <td>8eebd9ad-e271-4989-a796-d60c57655743</td>\n",
       "      <td></td>\n",
       "      <td>Succeeded</td>\n",
       "      <td>2020-08-21T22:39:51.9424694Z</td>\n",
       "      <td>[{'id': '/subscriptions/8eebd9ad-e271-4989-a796-d60c57655743/resourceGroups/LinuxTestLab/provide...</td>\n",
       "      <td>MSTICAttacker</td>\n",
       "      <td>True</td>\n",
       "      <td>[]</td>\n",
       "      <td>azureuser</td>\n",
       "      <td>Canonical</td>\n",
       "      <td>18.04.202008180</td>\n",
       "      <td>latest</td>\n",
       "      <td>18.04-LTS</td>\n",
       "      <td>UbuntuServer</td>\n",
       "      <td>[]</td>\n",
       "      <td>MSTICAttacker_OsDisk_1_765374ae02d94ee3a263c1bfa2403989</td>\n",
       "      <td>FromImage</td>\n",
       "      <td>Linux</td>\n",
       "      <td>/subscriptions/8eebd9ad-e271-4989-a796-d60c57655743/resourceGroups/LINUXTESTLAB/providers/Micros...</td>\n",
       "      <td>ReadWrite</td>\n",
       "      <td>Standard_A2_v2</td>\n",
       "      <td>True</td>\n",
       "      <td>a27225e9-e059-458b-9d1d-281897f1f773</td>\n",
       "      <td>V1</td>\n",
       "      <td>VM deallocated</td>\n",
       "      <td>Info</td>\n",
       "      <td>PowerState/deallocated</td>\n",
       "      <td>true</td>\n",
       "      <td>nonprod</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>/subscriptions/9083b91f-eeee-467c-9770-82df2b1f0420/resourceGroups/securitydata/providers/Micros...</td>\n",
       "      <td>mstic-graphistry</td>\n",
       "      <td>microsoft.compute/virtualmachines</td>\n",
       "      <td>72f988bf-86f1-41af-91ab-2d7cd011db47</td>\n",
       "      <td></td>\n",
       "      <td>eastus</td>\n",
       "      <td>securitydata</td>\n",
       "      <td>9083b91f-eeee-467c-9770-82df2b1f0420</td>\n",
       "      <td></td>\n",
       "      <td>Succeeded</td>\n",
       "      <td>2019-04-15T16:22:58.4745693Z</td>\n",
       "      <td>[{'id': '/subscriptions/9083b91f-eeee-467c-9770-82df2b1f0420/resourceGroups/securitydata/provide...</td>\n",
       "      <td>mstic-graphistry</td>\n",
       "      <td>True</td>\n",
       "      <td>[]</td>\n",
       "      <td>ashwin</td>\n",
       "      <td>Canonical</td>\n",
       "      <td>16.04.201904060</td>\n",
       "      <td>latest</td>\n",
       "      <td>16.04-LTS</td>\n",
       "      <td>UbuntuServer</td>\n",
       "      <td>[]</td>\n",
       "      <td>mstic-graphistry_OsDisk_1_ad3d2eea83c246d9b4c76e909a9be538</td>\n",
       "      <td>FromImage</td>\n",
       "      <td>Linux</td>\n",
       "      <td>/subscriptions/9083b91f-eeee-467c-9770-82df2b1f0420/resourceGroups/SECURITYDATA/providers/Micros...</td>\n",
       "      <td>ReadWrite</td>\n",
       "      <td>Standard_NC6</td>\n",
       "      <td>True</td>\n",
       "      <td>118b393a-4e02-434e-bc74-abed6504bbbc</td>\n",
       "      <td>V1</td>\n",
       "      <td>VM deallocated</td>\n",
       "      <td>Info</td>\n",
       "      <td>PowerState/deallocated</td>\n",
       "      <td>true</td>\n",
       "      <td>nonprod</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                                                                                                    id  \\\n",
       "0  /subscriptions/40dcc8bf-0478-4f3b-b275-ed0a94f2c013/resourceGroups/ASIHuntOMSWorkspaceRG/provide...   \n",
       "1  /subscriptions/40dcc8bf-0478-4f3b-b275-ed0a94f2c013/resourceGroups/asihuntomsworkspacerg/provide...   \n",
       "2  /subscriptions/40dcc8bf-0478-4f3b-b275-ed0a94f2c013/resourceGroups/asihuntomsworkspacerg/provide...   \n",
       "3  /subscriptions/8eebd9ad-e271-4989-a796-d60c57655743/resourceGroups/LinuxTestLab/providers/Micros...   \n",
       "4  /subscriptions/9083b91f-eeee-467c-9770-82df2b1f0420/resourceGroups/securitydata/providers/Micros...   \n",
       "\n",
       "               name                               type  \\\n",
       "0   MSTICAlertsWin1  microsoft.compute/virtualmachines   \n",
       "1     MSTICRHELLXVM  microsoft.compute/virtualmachines   \n",
       "2        MSTICULXVM  microsoft.compute/virtualmachines   \n",
       "3     MSTICAttacker  microsoft.compute/virtualmachines   \n",
       "4  mstic-graphistry  microsoft.compute/virtualmachines   \n",
       "\n",
       "                               tenantId kind location          resourceGroup  \\\n",
       "0  72f988bf-86f1-41af-91ab-2d7cd011db47        eastus  asihuntomsworkspacerg   \n",
       "1  72f988bf-86f1-41af-91ab-2d7cd011db47        eastus  asihuntomsworkspacerg   \n",
       "2  72f988bf-86f1-41af-91ab-2d7cd011db47       eastus2  asihuntomsworkspacerg   \n",
       "3  72f988bf-86f1-41af-91ab-2d7cd011db47       eastus2           linuxtestlab   \n",
       "4  72f988bf-86f1-41af-91ab-2d7cd011db47        eastus           securitydata   \n",
       "\n",
       "                         subscriptionId managedBy  \\\n",
       "0  40dcc8bf-0478-4f3b-b275-ed0a94f2c013             \n",
       "1  40dcc8bf-0478-4f3b-b275-ed0a94f2c013             \n",
       "2  40dcc8bf-0478-4f3b-b275-ed0a94f2c013             \n",
       "3  8eebd9ad-e271-4989-a796-d60c57655743             \n",
       "4  9083b91f-eeee-467c-9770-82df2b1f0420             \n",
       "\n",
       "  properties.provisioningState        properties.timeCreated  \\\n",
       "0                    Succeeded  2018-11-12T20:40:06.0459250Z   \n",
       "1                    Succeeded  2019-01-15T19:06:40.3178938Z   \n",
       "2                    Succeeded  2019-01-04T18:55:57.6286475Z   \n",
       "3                    Succeeded  2020-08-21T22:39:51.9424694Z   \n",
       "4                    Succeeded  2019-04-15T16:22:58.4745693Z   \n",
       "\n",
       "                                                           properties.networkProfile.networkInterfaces  \\\n",
       "0  [{'id': '/subscriptions/40dcc8bf-0478-4f3b-b275-ed0a94f2c013/resourceGroups/ASIHuntOMSWorkspaceR...   \n",
       "1  [{'id': '/subscriptions/40dcc8bf-0478-4f3b-b275-ed0a94f2c013/resourceGroups/ASIHuntOMSWorkspaceR...   \n",
       "2  [{'id': '/subscriptions/40dcc8bf-0478-4f3b-b275-ed0a94f2c013/resourceGroups/ASIHuntOMSWorkspaceR...   \n",
       "3  [{'id': '/subscriptions/8eebd9ad-e271-4989-a796-d60c57655743/resourceGroups/LinuxTestLab/provide...   \n",
       "4  [{'id': '/subscriptions/9083b91f-eeee-467c-9770-82df2b1f0420/resourceGroups/securitydata/provide...   \n",
       "\n",
       "  properties.osProfile.computerName  \\\n",
       "0                   MSTICAlertsWin1   \n",
       "1                     MSTICRHELLXVM   \n",
       "2                        MSTICULXVM   \n",
       "3                     MSTICAttacker   \n",
       "4                  mstic-graphistry   \n",
       "\n",
       "   properties.osProfile.allowExtensionOperations properties.osProfile.secrets  \\\n",
       "0                                           True                           []   \n",
       "1                                           True                           []   \n",
       "2                                           True                           []   \n",
       "3                                           True                           []   \n",
       "4                                           True                           []   \n",
       "\n",
       "  properties.osProfile.adminUsername  \\\n",
       "0                         MSTICAdmin   \n",
       "1                             russmc   \n",
       "2                             russmc   \n",
       "3                          azureuser   \n",
       "4                             ashwin   \n",
       "\n",
       "  properties.storageProfile.imageReference.publisher  \\\n",
       "0                             MicrosoftWindowsServer   \n",
       "1                                             RedHat   \n",
       "2                                          Canonical   \n",
       "3                                          Canonical   \n",
       "4                                          Canonical   \n",
       "\n",
       "  properties.storageProfile.imageReference.exactVersion  \\\n",
       "0                                     2016.127.20181010   \n",
       "1                                        7.6.2018103108   \n",
       "2                                       18.04.201812060   \n",
       "3                                       18.04.202008180   \n",
       "4                                       16.04.201904060   \n",
       "\n",
       "  properties.storageProfile.imageReference.version  \\\n",
       "0                                           latest   \n",
       "1                                           latest   \n",
       "2                                           latest   \n",
       "3                                           latest   \n",
       "4                                           latest   \n",
       "\n",
       "  properties.storageProfile.imageReference.sku  \\\n",
       "0                              2016-Datacenter   \n",
       "1                                        7-RAW   \n",
       "2                                    18.04-LTS   \n",
       "3                                    18.04-LTS   \n",
       "4                                    16.04-LTS   \n",
       "\n",
       "  properties.storageProfile.imageReference.offer  \\\n",
       "0                                  WindowsServer   \n",
       "1                                           RHEL   \n",
       "2                                   UbuntuServer   \n",
       "3                                   UbuntuServer   \n",
       "4                                   UbuntuServer   \n",
       "\n",
       "  properties.storageProfile.dataDisks  \\\n",
       "0                                  []   \n",
       "1                                  []   \n",
       "2                                  []   \n",
       "3                                  []   \n",
       "4                                  []   \n",
       "\n",
       "                        properties.storageProfile.osDisk.name  \\\n",
       "0   MSTICAlertsWin1_OsDisk_1_52bcecd0dbd54d508de086940988ffe8   \n",
       "1     MSTICRHELLXVM_OsDisk_1_a422f94406464badacdb491b39e33efc   \n",
       "2        MSTICULXVM_OsDisk_1_fecd1b61f61d461e93553b511dd2ec6b   \n",
       "3     MSTICAttacker_OsDisk_1_765374ae02d94ee3a263c1bfa2403989   \n",
       "4  mstic-graphistry_OsDisk_1_ad3d2eea83c246d9b4c76e909a9be538   \n",
       "\n",
       "  properties.storageProfile.osDisk.createOption  \\\n",
       "0                                     FromImage   \n",
       "1                                     FromImage   \n",
       "2                                     FromImage   \n",
       "3                                     FromImage   \n",
       "4                                     FromImage   \n",
       "\n",
       "  properties.storageProfile.osDisk.osType  \\\n",
       "0                                 Windows   \n",
       "1                                   Linux   \n",
       "2                                   Linux   \n",
       "3                                   Linux   \n",
       "4                                   Linux   \n",
       "\n",
       "                                                       properties.storageProfile.osDisk.managedDisk.id  \\\n",
       "0  /subscriptions/40dcc8bf-0478-4f3b-b275-ed0a94f2c013/resourceGroups/ASIHuntOMSWorkspaceRG/provide...   \n",
       "1  /subscriptions/40dcc8bf-0478-4f3b-b275-ed0a94f2c013/resourceGroups/ASIHuntOMSWorkspaceRG/provide...   \n",
       "2  /subscriptions/40dcc8bf-0478-4f3b-b275-ed0a94f2c013/resourceGroups/ASIHuntOMSWorkspaceRG/provide...   \n",
       "3  /subscriptions/8eebd9ad-e271-4989-a796-d60c57655743/resourceGroups/LINUXTESTLAB/providers/Micros...   \n",
       "4  /subscriptions/9083b91f-eeee-467c-9770-82df2b1f0420/resourceGroups/SECURITYDATA/providers/Micros...   \n",
       "\n",
       "  properties.storageProfile.osDisk.caching properties.hardwareProfile.vmSize  \\\n",
       "0                                ReadWrite                   Standard_DS2_v2   \n",
       "1                                ReadWrite                          Basic_A0   \n",
       "2                                ReadWrite                       Standard_A0   \n",
       "3                                ReadWrite                    Standard_A2_v2   \n",
       "4                                ReadWrite                      Standard_NC6   \n",
       "\n",
       "   properties.diagnosticsProfile.bootDiagnostics.enabled  \\\n",
       "0                                                   True   \n",
       "1                                                   True   \n",
       "2                                                   True   \n",
       "3                                                   True   \n",
       "4                                                   True   \n",
       "\n",
       "                        properties.vmId  \\\n",
       "0  3b8d40a2-33fa-4230-9dc1-794aabdd225c   \n",
       "1  ca085263-467b-482f-8603-8faa71a5f054   \n",
       "2  98741e0c-549f-459d-97fd-9c8a3848b71d   \n",
       "3  a27225e9-e059-458b-9d1d-281897f1f773   \n",
       "4  118b393a-4e02-434e-bc74-abed6504bbbc   \n",
       "\n",
       "  properties.extended.instanceView.hyperVGeneration  \\\n",
       "0                                                V1   \n",
       "1                                                V1   \n",
       "2                                                V1   \n",
       "3                                                V1   \n",
       "4                                                V1   \n",
       "\n",
       "  properties.extended.instanceView.powerState.displayStatus  \\\n",
       "0                                            VM deallocated   \n",
       "1                                            VM deallocated   \n",
       "2                                            VM deallocated   \n",
       "3                                            VM deallocated   \n",
       "4                                            VM deallocated   \n",
       "\n",
       "  properties.extended.instanceView.powerState.level  \\\n",
       "0                                              Info   \n",
       "1                                              Info   \n",
       "2                                              Info   \n",
       "3                                              Info   \n",
       "4                                              Info   \n",
       "\n",
       "  properties.extended.instanceView.powerState.code  \\\n",
       "0                           PowerState/deallocated   \n",
       "1                           PowerState/deallocated   \n",
       "2                           PowerState/deallocated   \n",
       "3                           PowerState/deallocated   \n",
       "4                           PowerState/deallocated   \n",
       "\n",
       "  tags.platformsettings.host_environment.service.platform_optedin_for_rootcerts  \\\n",
       "0                                                                          true   \n",
       "1                                                                          true   \n",
       "2                                                                          true   \n",
       "3                                                                          true   \n",
       "4                                                                          true   \n",
       "\n",
       "  tags.azsecpack  \n",
       "0        nonprod  \n",
       "1        nonprod  \n",
       "2        nonprod  \n",
       "3        nonprod  \n",
       "4        nonprod  "
      ]
     },
     "execution_count": 52,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "res_qry_prov.exec_query(\"Resources | where type == 'microsoft.compute/virtualmachines' | where name contains 'MSTIC'\").dropna(axis=1)"
   ]
  },
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3.8.10 ('dev38')",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.3"
  },
  "orig_nbformat": 4,
  "vscode": {
   "interpreter": {
    "hash": "739aa94d41434660cad201339437bbf6f0b217d6c8b6dd6d17fce87baec5c88f"
   }
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
